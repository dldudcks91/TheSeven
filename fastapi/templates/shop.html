<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상점</title>
    <style>
        /* 기존 스타일 그대로 유지 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-size: 12px; padding: 10px; background-color: white; margin: 0; }
        .container { max-width: 100%; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; 
        }
        .game-section h3 { margin: 0; padding: 0; font-size: 16px; }
        .refresh-btn { padding: 5px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 12px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .shop-item { padding: 15px; border: 1px solid #eee; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; }
        .shop-item.sold { opacity: 0.5; background: #eee; }
        .item-name { font-weight: bold; display: block; margin-bottom: 5px; }
        .item-desc { font-size: 12px; color: #666; }
        .buy-btn { padding: 6px 12px; background: #333; color: #fff; border: none; cursor: pointer; }
        .buy-btn:disabled { background: #ccc; cursor: not-allowed; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-section">
            <div class="header">
                <h3>Shop</h3>
                <button class="refresh-btn" onclick="refreshShop()">새로고침</button>
            </div>
            <div id="message" class="message"></div>
            <div id="shop-grid" class="shop-grid">
                <div class="loading">로딩 중...</div>
            </div>
        </div>
    </div>

    <script>
        const API_CODE = { SHOP_INFO: 6011, SHOP_REFRESH: 6012, SHOP_BUY: 6013 };
        let currentUserId = null; // 내부 유지용 유저 ID

        // [핵심] 부모창(main.html)으로부터 메시지 수신
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = parseInt(event.data.userId);
                // 유저 ID가 실제로 바뀌었을 때만 다시 로드
                if (currentUserId !== newUserId) {
                    console.log("Shop: User ID changed to", newUserId);
                    currentUserId = newUserId;
                    loadShop(); 
                }
            }
        });

        // 유저 번호 결정 우선순위 함수
        function getUserNo() {
            if (currentUserId) return currentUserId; // 1. 메시지로 받은 ID 우선
            if (window.parent && window.parent.currentUserId) {
                currentUserId = parseInt(window.parent.currentUserId); // 2. 부모 변수 직접 참조
                return currentUserId;
            }
            return parseInt(localStorage.getItem('user_no')) || 2; // 3. 기본값
        }

        // 아이템 가속/자원 정보 변환
        function getItemDescription(itemInfo) {
            const { category, sub_category, value } = itemInfo;
            if (category === 'resource') {
                const resNames = { 'food': '식량', 'stone': '석재', 'gold': '골드', 'wood': '목재', 'iron': '철광' };
                return `${resNames[sub_category] || sub_category} +${value.toLocaleString()}`;
            } else if (category === 'speedup') {
                const min = Math.floor(value / 60);
                const h = Math.floor(min / 60);
                const m = min % 60;
                let timeStr = h > 0 ? `${h}시간 ` : "";
                if (m > 0 || h === 0) timeStr += `${m}분`;
                return `${sub_category === 'building' ? '건설' : '연구'} ${timeStr.trim()} 가속`;
            }
            return itemInfo.korean_name || '아이템';
        }

        async function apiRequest(apiCode, data = {}) {
            const uid = getUserNo(); // 최신 ID 가져오기
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_no: uid, api_code: apiCode, data: data })
                });
                return await response.json();
            } catch (error) {
                return { success: false, message: "서버 연결 실패" };
            }
        }

        async function loadShop() {
            const gridEl = document.getElementById('shop-grid');
            const result = await apiRequest(API_CODE.SHOP_INFO);
            if (result.success) {
                renderShop(result.data);
            } else {
                showMessage(result.message || '정보 로드 실패', 'error');
                gridEl.innerHTML = '<div class="loading">데이터 로드 실패</div>';
            }
        }

        function renderShop(shopData) {
            const gridEl = document.getElementById('shop-grid');
            const slots = shopData.slots || [];
            if (slots.length === 0) {
                gridEl.innerHTML = '<div class="loading">상점이 비어있습니다.</div>';
                return;
            }
            
            gridEl.innerHTML = slots.map(slot => {
                const item = slot.item_info || {};
                const isSold = slot.sold;
                const desc = getItemDescription(item);
                const priceText = item.price === 0 ? '무료' : `${item.price.toLocaleString()} ${item.price_type}`;
                
                return `
                    <div class="shop-item ${isSold ? 'sold' : ''}">
                        <div class="item-info">
                            <span class="item-name">${item.korean_name || desc}</span>
                            <span class="item-desc">${desc} | 가격: ${priceText}</span>
                        </div>
                        <button class="buy-btn" onclick="buyItem(${slot.slot})" ${isSold ? 'disabled' : ''}>
                            ${isSold ? '구매완료' : '구매'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function refreshShop() {
            const btn = document.querySelector('.refresh-btn');
            btn.disabled = true;
            btn.textContent = '...';
            const result = await apiRequest(API_CODE.SHOP_REFRESH);
            btn.disabled = false; btn.textContent = '새로고침';
            if (result.success) {
                showMessage('상점이 갱신되었습니다.', 'success');
                renderShop(result.data);
            } else { showMessage(result.message, 'error'); }
        }

        async function buyItem(slotIndex) {
            const result = await apiRequest(API_CODE.SHOP_BUY, { slot: slotIndex });
            if (result.success) {
                showMessage(`구매 성공!`, 'success');
                loadShop();
                
                // 부모에게 아이템 갱신 요청
                window.parent.postMessage({ type: 'refresh_item' }, '*');
            } else { 
                showMessage(result.message || '구매 실패', 'error'); 
            }
        }    
        function showMessage(text, type) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = `message ${type}`;
            setTimeout(() => { msgEl.className = 'message'; }, 3000);
        }

        window.onload = function() {
            // 부모창에게 설정 요청 메시지 전송
            window.parent.postMessage({ type: 'request_config', configType: 'shop' }, '*');
            loadShop();
        };
    </script>
</body>
</html>