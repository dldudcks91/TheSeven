<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ë§¹</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; padding: 0; background-color: #f5f5f5; margin: 0; }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .ally-tabs { display: flex; border-bottom: 1px solid #ccc; background: #f9f9f9; padding: 0 10px; }
        .ally-tab { padding: 8px 14px; border: none; background: none; cursor: pointer; font-size: 12px; border-bottom: 2px solid transparent; color: #666; }
        .ally-tab.active { border-bottom: 2px solid #333; color: #333; font-weight: bold; }
        .ally-tab:hover { color: #333; }
        
        /* ì„¹ì…˜ ì»¨í…Œì´ë„ˆ */
        .ally-content { display: none; padding: 10px; }
        .ally-content.active { display: block; }
        
        /* ê³µí†µ */
        .section-title { margin: 0 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd; font-size: 14px; }
        .ally-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .ally-table th, .ally-table td { padding: 4px 6px; text-align: center; border: 1px solid #ddd; }
        .ally-table th { background-color: #f5f5f5; font-weight: bold; }
        .btn { padding: 3px 8px; background: #fff; color: #333; border: 1px solid #ddd; cursor: pointer; font-size: 11px; border-radius: 2px; }
        .btn:hover { background: #eee; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-primary { background: #333; color: #fff; border-color: #333; }
        .btn-primary:hover { background: #555; }
        .btn-danger { color: #d33; border-color: #d33; }
        .btn-danger:hover { background: #fdd; }
        
        .result-box { margin-top: 8px; padding: 8px; border-radius: 4px; display: none; font-size: 11px; }
        .result-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .empty-msg { text-align: center; padding: 20px; color: #999; }
        
        /* ì—°ë§¹ ì •ë³´ ì¹´ë“œ */
        .info-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
        .info-label { color: #888; }
        .info-value { font-weight: bold; }
        
        /* ê³µì§€ì‚¬í•­ */
        .notice-box { background: #fffde7; border: 1px solid #ffe082; border-radius: 4px; padding: 10px; margin-bottom: 10px; font-size: 12px; }
        .notice-box .notice-date { color: #999; font-size: 10px; margin-top: 4px; }
        .notice-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; resize: vertical; box-sizing: border-box; }
        
        /* ê¸°ë¶€ */
        .donate-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .donate-row select, .donate-row input { padding: 4px 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .donate-row input[type=number] { width: 100px; }
        
        /* ì—°êµ¬ */
        .research-item { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 8px; }
        .research-item.active-research { border-color: #4caf50; background: #f1f8e9; }
        .research-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .research-name { font-weight: bold; font-size: 13px; }
        .research-level { color: #666; }
        .progress-bar { background: #eee; border-radius: 3px; height: 14px; overflow: hidden; position: relative; }
        .progress-fill { background: #4caf50; height: 100%; border-radius: 3px; transition: width 0.3s; }
        .progress-text { position: absolute; top: 0; left: 0; right: 0; text-align: center; font-size: 10px; line-height: 14px; color: #333; }
        .active-badge { display: inline-block; background: #4caf50; color: #fff; font-size: 10px; padding: 1px 6px; border-radius: 8px; margin-left: 6px; }
        
        /* ê²€ìƒ‰ */
        .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .search-row input { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        
        /* ë¯¸ê°€ì… ìƒíƒœ */
        .no-alliance { text-align: center; padding: 40px 20px; }
        .no-alliance h3 { margin-bottom: 15px; color: #666; }
        .no-alliance .btn { margin: 5px; padding: 8px 20px; font-size: 13px; }
        
        /* ê°€ì…ì‹ ì²­ ëª©ë¡ */
        .app-badge { display: inline-block; background: #ff5722; color: #fff; font-size: 10px; padding: 0 5px; border-radius: 8px; margin-left: 4px; }
    </style>
</head>
<body>
    <!-- ì—°ë§¹ ë¯¸ê°€ì… ìƒíƒœ -->
    <div id="noAllianceView" class="no-alliance" style="display:none;">
        <h3>ì†Œì†ëœ ì—°ë§¹ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <button class="btn btn-primary" onclick="showCreateModal()">ì—°ë§¹ ìƒì„±</button>
        <button class="btn" onclick="switchTab('search')">ì—°ë§¹ ê²€ìƒ‰</button>
        
        <!-- ìƒì„± í¼ -->
        <div id="createForm" style="display:none; margin-top:15px; text-align:left; max-width:300px; margin-left:auto; margin-right:auto;">
            <div style="margin-bottom:8px;">
                <label>ì—°ë§¹ ì´ë¦„:</label>
                <input type="text" id="createName" maxlength="20" placeholder="2~20ì" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:3px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:8px;">
                <label>ê°€ì… ë°©ì‹:</label>
                <select id="createJoinType" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:3px;">
                    <option value="free">ììœ ê°€ì…</option>
                    <option value="approval">ìŠ¹ì¸ì œ</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="createAlliance()">ìƒì„±</button>
            <button class="btn" onclick="hideCreateModal()">ì·¨ì†Œ</button>
        </div>
    </div>
    
    <!-- ì—°ë§¹ ê°€ì… ìƒíƒœ -->
    <div id="allianceView" style="display:none;">
        <!-- íƒ­ -->
        <div class="ally-tabs">
            <button class="ally-tab active" onclick="switchTab('info')">ì •ë³´</button>
            <button class="ally-tab" onclick="switchTab('members')">ë©¤ë²„</button>
            <button class="ally-tab" onclick="switchTab('notice')">ê³µì§€</button>
            <button class="ally-tab" onclick="switchTab('donate')">ê¸°ë¶€</button>
            <button class="ally-tab" onclick="switchTab('research')">ì—°êµ¬</button>
            <button class="ally-tab" id="tabApplications" onclick="switchTab('applications')" style="display:none;">ì‹ ì²­<span id="appBadge" class="app-badge" style="display:none;">0</span></button>
            <button class="ally-tab" onclick="switchTab('search')">ê²€ìƒ‰</button>
        </div>
        
        <!-- ì •ë³´ íƒ­ -->
        <div id="section-info" class="ally-content active">
            <div class="info-card">
                <div class="info-row"><span class="info-label">ì—°ë§¹ëª…</span><span class="info-value" id="infoName">-</span></div>
                <div class="info-row"><span class="info-label">ë ˆë²¨</span><span class="info-value" id="infoLevel">-</span></div>
                <div class="info-row"><span class="info-label">ê²½í—˜ì¹˜</span><span class="info-value" id="infoExp">-</span></div>
                <div class="info-row"><span class="info-label">ì¸ì›</span><span class="info-value" id="infoMembers">-</span></div>
                <div class="info-row"><span class="info-label">ë§¹ì£¼</span><span class="info-value" id="infoLeader">-</span></div>
                <div class="info-row"><span class="info-label">ê°€ì…ë°©ì‹</span><span class="info-value" id="infoJoinType">-</span></div>
                <div class="info-row"><span class="info-label">ë‚´ ì§ì±…</span><span class="info-value" id="infoMyPosition">-</span></div>
                <div class="info-row"><span class="info-label">í™œì„± ì—°êµ¬</span><span class="info-value" id="infoActiveResearch">-</span></div>
            </div>
            <div id="infoActions" style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn" id="btnSetJoinType" onclick="toggleJoinType()" style="display:none;">ê°€ì…ë°©ì‹ ë³€ê²½</button>
                <button class="btn btn-danger" id="btnLeave" onclick="leaveAlliance()">íƒˆí‡´</button>
                <button class="btn btn-danger" id="btnDisband" onclick="disbandAlliance()" style="display:none;">í•´ì‚°</button>
            </div>
        </div>
        
        <!-- ë©¤ë²„ íƒ­ -->
        <div id="section-members" class="ally-content">
            <h4 class="section-title">ë©¤ë²„ ëª©ë¡</h4>
            <table class="ally-table">
                <thead><tr><th>ìœ ì €</th><th>ì§ì±…</th><th>ê¸°ë¶€(EXP)</th><th>ê¸°ë¶€(ì½”ì¸)</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="memberTableBody"><tr><td colspan="5" class="empty-msg">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
        
        <!-- ê³µì§€ íƒ­ -->
        <div id="section-notice" class="ally-content">
            <h4 class="section-title">ê³µì§€ì‚¬í•­</h4>
            <div id="noticeDisplay" class="notice-box" style="display:none;">
                <div id="noticeContent">-</div>
                <div class="notice-date" id="noticeDate">-</div>
            </div>
            <div id="noticeEmpty" class="empty-msg">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div id="noticeWriteArea" style="display:none; margin-top:10px;">
                <textarea id="noticeInput" class="notice-input" rows="3" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <button class="btn btn-primary" onclick="writeNotice()" style="margin-top:6px;">ê³µì§€ ë“±ë¡</button>
            </div>
        </div>
        
        <!-- ê¸°ë¶€ íƒ­ -->
        <div id="section-donate" class="ally-content">
            <h4 class="section-title">ìì› ê¸°ë¶€</h4>
            <div class="donate-row">
                <select id="donateResource">
                    <option value="food">ğŸŒ¾ ì‹ëŸ‰</option>
                    <option value="wood">ğŸªµ ëª©ì¬</option>
                    <option value="stone">ğŸ—¿ ì„ì¬</option>
                    <option value="gold">ğŸ’° ê³¨ë“œ</option>
                </select>
                <input type="number" id="donateAmount" min="1" value="1000" placeholder="ìˆ˜ëŸ‰">
                <button class="btn btn-primary" onclick="donate()">ê¸°ë¶€</button>
            </div>
            <div class="info-card" id="donateResult" style="display:none;">
                <div class="info-row"><span class="info-label">ê¸°ë¶€ ìì›</span><span class="info-value" id="donateResType">-</span></div>
                <div class="info-row"><span class="info-label">ê¸°ë¶€ëŸ‰</span><span class="info-value" id="donateResAmount">-</span></div>
                <div class="info-row"><span class="info-label">íšë“ ê²½í—˜ì¹˜</span><span class="info-value" id="donateExpGained">-</span></div>
                <div class="info-row"><span class="info-label">íšë“ ì½”ì¸</span><span class="info-value" id="donateCoinGained">-</span></div>
            </div>
        </div>
        
        <!-- ì—°êµ¬ íƒ­ -->
        <div id="section-research" class="ally-content">
            <h4 class="section-title">ì—°ë§¹ ì—°êµ¬</h4>
            <div id="researchList"><div class="empty-msg">ë¡œë”© ì¤‘...</div></div>
        </div>
        
        <!-- ê°€ì…ì‹ ì²­ íƒ­ -->
        <div id="section-applications" class="ally-content">
            <h4 class="section-title">ê°€ì… ì‹ ì²­ ëª©ë¡</h4>
            <table class="ally-table">
                <thead><tr><th>ìœ ì €</th><th>ì‹ ì²­ì¼</th><th>ì²˜ë¦¬</th></tr></thead>
                <tbody id="appTableBody"><tr><td colspan="3" class="empty-msg">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
        
        <!-- ê²€ìƒ‰ íƒ­ -->
        <div id="section-search" class="ally-content">
            <h4 class="section-title">ì—°ë§¹ ê²€ìƒ‰</h4>
            <div class="search-row">
                <input type="text" id="searchKeyword" placeholder="ì—°ë§¹ ì´ë¦„ ê²€ìƒ‰">
                <button class="btn" onclick="searchAlliance()">ê²€ìƒ‰</button>
            </div>
            <table class="ally-table">
                <thead><tr><th>ì´ë¦„</th><th>ë ˆë²¨</th><th>ì¸ì›</th><th>ê°€ì…</th></tr></thead>
                <tbody id="searchTableBody"><tr><td colspan="4" class="empty-msg">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</td></tr></tbody>
            </table>
        </div>
    </div>
    
    <div id="result" class="result-box"></div>

    <script>
        let currentUserId = null;
        let allianceData = null;   // ì—°ë§¹ ì •ë³´
        let myPosition = null;     // ë‚´ ì§ì±…
        let currentAllianceId = null;

        // ==================== ë©”ì‹œì§€ ìˆ˜ì‹  ====================
        
        window.addEventListener('message', async function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = parseInt(event.data.userId);
                if (currentUserId !== newUserId) {
                    currentUserId = newUserId;
                    await loadAllianceInfo();
                }
            }
        });

        function getUserNo() {
            if (currentUserId) return currentUserId;
            if (window.parent && window.parent.currentUserId) {
                currentUserId = parseInt(window.parent.currentUserId);
                return currentUserId;
            }
            return null;
        }

        // ==================== íƒ­ ì „í™˜ ====================
        
        function switchTab(tabName) {
            document.querySelectorAll('.ally-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.ally-content').forEach(c => c.classList.remove('active'));
            
            const section = document.getElementById(`section-${tabName}`);
            if (section) section.classList.add('active');
            
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.ally-tab').forEach(t => {
                if (t.textContent.includes(getTabLabel(tabName))) t.classList.add('active');
            });
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tabName === 'members') loadMembers();
            if (tabName === 'research') loadResearch();
            if (tabName === 'applications') loadApplications();
            if (tabName === 'search') { /* ê²€ìƒ‰ì€ ë²„íŠ¼ í´ë¦­ ì‹œ */ }
        }
        
        function getTabLabel(tabName) {
            const labels = { info: 'ì •ë³´', members: 'ë©¤ë²„', notice: 'ê³µì§€', donate: 'ê¸°ë¶€', research: 'ì—°êµ¬', applications: 'ì‹ ì²­', search: 'ê²€ìƒ‰' };
            return labels[tabName] || tabName;
        }

        // ==================== API í˜¸ì¶œ ê³µí†µ ====================
        
        async function apiCall(apiCode, data = {}) {
            const uid = getUserNo();
            if (!uid) return null;
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_no: uid, api_code: apiCode, data: data })
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, message: error.message };
            }
        }

        // ==================== ì—°ë§¹ ì •ë³´ ë¡œë“œ ====================
        
        async function loadAllianceInfo() {
            const result = await apiCall(7001);
            console.log("Alliance Info:", result);
            
            if (!result || !result.success) {
                showNoAlliance();
                return;
            }
            
            const data = result.data;
            
            if (!data.has_alliance || !data.alliance) {
                showNoAlliance();
                return;
            }
            
            allianceData = data.alliance;
            myPosition = data.my_position;
            currentAllianceId = allianceData.alliance_id;
            
            showAllianceView();
            renderAllianceInfo(data);
        }
        
        function showNoAlliance() {
            document.getElementById('noAllianceView').style.display = 'block';
            document.getElementById('allianceView').style.display = 'none';
            allianceData = null;
            myPosition = null;
            currentAllianceId = null;
        }
        
        function showAllianceView() {
            document.getElementById('noAllianceView').style.display = 'none';
            document.getElementById('allianceView').style.display = 'block';
        }
        
        function renderAllianceInfo(data) {
            const a = data.alliance;
            
            document.getElementById('infoName').textContent = a.name;
            document.getElementById('infoLevel').textContent = `Lv.${a.level}`;
            document.getElementById('infoExp').textContent = (a.exp || 0).toLocaleString();
            document.getElementById('infoMembers').textContent = `${a.member_count} / ${a.max_members}`;
            document.getElementById('infoLeader').textContent = `#${a.leader_no}`;
            document.getElementById('infoJoinType').textContent = a.join_type === 'free' ? 'ììœ ê°€ì…' : 'ìŠ¹ì¸ì œ';
            document.getElementById('infoMyPosition').textContent = getPositionName(myPosition);
            
            // í™œì„± ì—°êµ¬
            if (data.active_research) {
                document.getElementById('infoActiveResearch').textContent = `ì—°êµ¬ #${data.active_research.research_idx}`;
            } else {
                document.getElementById('infoActiveResearch').textContent = 'ì—†ìŒ';
            }
            
            // ê³µì§€
            if (data.notice) {
                document.getElementById('noticeDisplay').style.display = 'block';
                document.getElementById('noticeEmpty').style.display = 'none';
                document.getElementById('noticeContent').textContent = data.notice.content;
                document.getElementById('noticeDate').textContent = data.notice.updated_at || '';
            } else {
                document.getElementById('noticeDisplay').style.display = 'none';
                document.getElementById('noticeEmpty').style.display = 'block';
            }
            
            // ê¶Œí•œë³„ UI
            renderPermissionUI();
        }
        
        function renderPermissionUI() {
            const isLeader = myPosition === 1;
            const isOfficer = myPosition <= 3;
            
            // ë§¹ì£¼ ì „ìš©
            document.getElementById('btnSetJoinType').style.display = isLeader ? 'inline-block' : 'none';
            document.getElementById('btnDisband').style.display = isLeader ? 'inline-block' : 'none';
            document.getElementById('btnLeave').style.display = isLeader ? 'none' : 'inline-block';
            document.getElementById('noticeWriteArea').style.display = isLeader ? 'block' : 'none';
            
            // ê°„ë¶€ ì´ìƒ: ì‹ ì²­ íƒ­ í‘œì‹œ
            document.getElementById('tabApplications').style.display = isOfficer ? 'inline-block' : 'none';
        }
        
        function getPositionName(pos) {
            switch(pos) {
                case 1: return 'ë§¹ì£¼';
                case 2: return 'ë¶€ë§¹ì£¼';
                case 3: return 'ê°„ë¶€';
                case 4: return 'ì¼ë°˜';
                default: return '-';
            }
        }

        // ==================== ì—°ë§¹ ìƒì„± ====================
        
        function showCreateModal() {
            document.getElementById('createForm').style.display = 'block';
        }
        
        function hideCreateModal() {
            document.getElementById('createForm').style.display = 'none';
        }
        
        async function createAlliance() {
            const name = document.getElementById('createName').value.trim();
            const joinType = document.getElementById('createJoinType').value;
            
            if (!name || name.length < 2 || name.length > 20) {
                showResult('ì—°ë§¹ ì´ë¦„ì€ 2~20ìì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const result = await apiCall(7002, { name: name, join_type: joinType });
            
            if (result.success) {
                showResult('ì—°ë§¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                hideCreateModal();
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ì—°ë§¹ ê°€ì… ====================
        
        async function joinAlliance(allianceId) {
            const result = await apiCall(7003, { alliance_id: allianceId });
            
            if (result.success) {
                const status = result.data.status;
                showResult(status === 'joined' ? 'ì—°ë§¹ì— ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ê°€ì… ì‹ ì²­ ì™„ë£Œ!', 'success');
                if (status === 'joined') await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ì—°ë§¹ íƒˆí‡´ ====================
        
        async function leaveAlliance() {
            if (!confirm('ì •ë§ ì—°ë§¹ì„ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const result = await apiCall(7004);
            if (result.success) {
                showResult('ì—°ë§¹ì„ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤', 'success');
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ì—°ë§¹ í•´ì‚° ====================
        
        async function disbandAlliance() {
            if (!confirm('ì •ë§ ì—°ë§¹ì„ í•´ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            const result = await apiCall(7013);
            if (result.success) {
                showResult('ì—°ë§¹ì´ í•´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ê°€ì…ë°©ì‹ ë³€ê²½ ====================
        
        async function toggleJoinType() {
            const current = allianceData.join_type;
            const newType = current === 'free' ? 'approval' : 'free';
            
            const result = await apiCall(7012, { join_type: newType });
            if (result.success) {
                showResult(`ê°€ì… ë°©ì‹ì´ ${newType === 'free' ? 'ììœ ê°€ì…' : 'ìŠ¹ì¸ì œ'}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ë©¤ë²„ ëª©ë¡ ====================
        
        async function loadMembers() {
            const result = await apiCall(7006);
            if (!result || !result.success) return;
            
            const members = result.data.members || [];
            const tbody = document.getElementById('memberTableBody');
            
            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">ë©¤ë²„ ì—†ìŒ</td></tr>';
                return;
            }
            
            tbody.innerHTML = members.map(m => {
                let actions = '';
                // ë‚´ê°€ ê°„ë¶€ ì´ìƒì´ê³  ëŒ€ìƒì´ ë‚˜ë³´ë‹¤ í•˜ìœ„ì¼ ë•Œ
                if (myPosition <= 3 && m.position > myPosition && m.user_no !== currentUserId) {
                    actions += `<button class="btn" onclick="kickMember(${m.user_no})">ì¶”ë°©</button> `;
                }
                if (myPosition <= 2 && m.user_no !== currentUserId) {
                    actions += `<button class="btn" onclick="promoteMember(${m.user_no})">ì§ì±…ë³€ê²½</button>`;
                }
                
                return `<tr>
                    <td>#${m.user_no}</td>
                    <td>${getPositionName(m.position)}</td>
                    <td>${(m.donated_exp || 0).toLocaleString()}</td>
                    <td>${(m.donated_coin || 0).toLocaleString()}</td>
                    <td>${actions || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        async function kickMember(targetNo) {
            if (!confirm(`ìœ ì € #${targetNo}ì„(ë¥¼) ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const result = await apiCall(7007, { target_user_no: targetNo });
            if (result.success) {
                showResult('ì¶”ë°© ì™„ë£Œ', 'success');
                await loadMembers();
            } else {
                showResult(result.message, 'error');
            }
        }
        
        async function promoteMember(targetNo) {
            const newPos = prompt('ìƒˆ ì§ì±… ë²ˆí˜¸ ì…ë ¥ (2:ë¶€ë§¹ì£¼, 3:ê°„ë¶€, 4:ì¼ë°˜)');
            if (!newPos) return;
            
            const result = await apiCall(7008, { target_user_no: targetNo, new_position: parseInt(newPos) });
            if (result.success) {
                showResult('ì§ì±… ë³€ê²½ ì™„ë£Œ', 'success');
                await loadMembers();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ê³µì§€ì‚¬í•­ ====================
        
        async function writeNotice() {
            const content = document.getElementById('noticeInput').value.trim();
            if (!content) {
                showResult('ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            const result = await apiCall(7015, { content: content });
            if (result.success) {
                showResult('ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                document.getElementById('noticeInput').value = '';
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ê¸°ë¶€ ====================
        
        async function donate() {
            const resourceType = document.getElementById('donateResource').value;
            const amount = parseInt(document.getElementById('donateAmount').value);
            
            if (!amount || amount <= 0) {
                showResult('ê¸°ë¶€ ìˆ˜ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            const result = await apiCall(7011, { resource_type: resourceType, amount: amount });
            
            if (result.success) {
                const d = result.data;
                document.getElementById('donateResult').style.display = 'block';
                document.getElementById('donateResType').textContent = resourceType;
                document.getElementById('donateResAmount').textContent = d.donated_amount.toLocaleString();
                document.getElementById('donateExpGained').textContent = d.exp_gained.toLocaleString();
                document.getElementById('donateCoinGained').textContent = d.coin_gained.toLocaleString();
                
                showResult(
                    `ê¸°ë¶€ ì„±ê³µ! EXP +${d.exp_gained} / ì½”ì¸ +${d.coin_gained}` +
                    (d.leveled_up ? ' ğŸ‰ ì—°ë§¹ ë ˆë²¨ì—…!' : '') +
                    (d.research_leveled_up ? ' ğŸ”¬ ì—°êµ¬ ë ˆë²¨ì—…!' : ''),
                    'success'
                );
                
                // ìì› ê°±ì‹ 
                window.parent.postMessage({ type: 'refresh_resource' }, '*');
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ì—°êµ¬ ====================
        
        async function loadResearch() {
            const result = await apiCall(7016);
            if (!result || !result.success) return;
            
            const list = result.data.research_list || [];
            const container = document.getElementById('researchList');
            
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-msg">ì—°êµ¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            container.innerHTML = list.map(r => {
                const progress = r.required_exp > 0 ? Math.min(100, (r.current_exp / r.required_exp * 100)).toFixed(1) : 100;
                const isActive = r.is_active;
                const isMax = r.is_max;
                const canSelect = myPosition <= 3 && !isMax;
                
                return `<div class="research-item ${isActive ? 'active-research' : ''}">
                    <div class="research-header">
                        <span>
                            <span class="research-name">ì—°êµ¬ #${r.research_idx}</span>
                            ${isActive ? '<span class="active-badge">ì§„í–‰ì¤‘</span>' : ''}
                        </span>
                        <span class="research-level">${isMax ? 'MAX' : `Lv.${r.level} / ${r.max_level}`}</span>
                    </div>
                    ${!isMax ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${progress}%"></div>
                            <div class="progress-text">${r.current_exp.toLocaleString()} / ${r.required_exp.toLocaleString()}</div>
                        </div>
                    ` : ''}
                    ${canSelect && !isActive ? `<button class="btn" onclick="selectResearch(${r.research_idx})" style="margin-top:6px;">ì´ ì—°êµ¬ í™œì„±í™”</button>` : ''}
                </div>`;
            }).join('');
        }
        
        async function selectResearch(researchIdx) {
            const result = await apiCall(7017, { research_idx: researchIdx });
            if (result.success) {
                showResult('ì—°êµ¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                await loadResearch();
                await loadAllianceInfo();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ê°€ì… ì‹ ì²­ ====================
        
        async function loadApplications() {
            const result = await apiCall(7009);
            if (!result || !result.success) return;
            
            const apps = result.data.applications || [];
            const tbody = document.getElementById('appTableBody');
            
            // ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('appBadge');
            if (apps.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = apps.length;
            } else {
                badge.style.display = 'none';
            }
            
            if (apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-msg">ì‹ ì²­ ì—†ìŒ</td></tr>';
                return;
            }
            
            tbody.innerHTML = apps.map(a => `<tr>
                <td>#${a.user_no}</td>
                <td>${a.applied_at || '-'}</td>
                <td>
                    <button class="btn btn-primary" onclick="approveApp(${a.user_no}, true)">ìŠ¹ì¸</button>
                    <button class="btn btn-danger" onclick="approveApp(${a.user_no}, false)">ê±°ì ˆ</button>
                </td>
            </tr>`).join('');
        }
        
        async function approveApp(targetNo, approve) {
            const result = await apiCall(7010, { target_user_no: targetNo, approve: approve });
            if (result.success) {
                showResult(approve ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ê±°ì ˆ ì™„ë£Œ', 'success');
                await loadApplications();
            } else {
                showResult(result.message, 'error');
            }
        }

        // ==================== ì—°ë§¹ ê²€ìƒ‰ ====================
        
        async function searchAlliance() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const result = await apiCall(7005, { keyword: keyword });
            
            if (!result || !result.success) return;
            
            const alliances = result.data.alliances || [];
            const tbody = document.getElementById('searchTableBody');
            
            if (alliances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>';
                return;
            }
            
            tbody.innerHTML = alliances.map(a => `<tr>
                <td>${a.name}</td>
                <td>Lv.${a.level}</td>
                <td>${a.member_count} / ${a.max_members || '?'}</td>
                <td><button class="btn" onclick="joinAlliance(${a.alliance_id})">ê°€ì…</button></td>
            </tr>`).join('');
        }

        // ==================== ê²°ê³¼ í‘œì‹œ ====================
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result-box ${type}`;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 4000);
        }

        // ==================== ì´ˆê¸°í™” ====================
        
        window.onload = function() {
            const uid = getUserNo();
            if (uid) loadAllianceInfo();
        };
    </script>
</body>
</html>