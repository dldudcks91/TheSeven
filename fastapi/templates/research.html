<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïó∞Íµ¨ Í¥ÄÎ¶¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            padding: 10px;
            margin: 0;
        }
        .game-section h3 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        .container {
            max-width: 100%;
            margin: 0;
        }
        strong {
            margin-right: 10px;
        }
        
        /* Î†àÏù¥ÏïÑÏõÉ */
        .research-layout {
            display: flex;
            gap: 15px;
            height: 70vh;
        }

        .tab-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding-right: 10px;
            border-right: 2px solid #ddd;
            margin-bottom: 0;
            min-width: 50px;
        }

        .tab-button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-right: none;
            background: #f5f5f5;
            cursor: pointer;
            text-align: left;
            border-radius: 4px 0 0 4px;
        }

        .tab-button.active {
            background-color: white;
            font-weight: bold;
            border-color: #ddd;
            border-right: none;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Ïó∞Íµ¨ Ìä∏Î¶¨ */
        .research-tree {
            position: relative;
            padding: 10px;
            background: white;
            border-radius: 8px;
            display: flex;
        }
        
        .research-tier {
            align-items: center;
            position: relative;
        }
        
        .research-nodes {
            gap: 40px;
            flex: 1;
            align-items: center;
            justify-content: flex-start;
            margin-left: 30px;
        }
        
        /* Ïó∞Íµ¨ ÎÖ∏Îìú */
        .research-node {
            position: relative;
            cursor: pointer;
            z-index: 10;
            margin-bottom: 5px;
        }
        
        .research-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 3px solid #ddd;
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .research-node:hover{
            z-index:10000;

        }
        .research-node:hover .research-icon {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            
        }
        
        .research-icon.completed {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }
        
        .research-icon.in-progress {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .research-icon.locked {
            border-color: #bbb;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .research-icon.available {
            border-color: #2196F3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
        }
        
        /* Î†àÎ≤® Î±ÉÏßÄ */
        .level-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .research-icon.completed .level-badge {
            background: #4caf50;
        }
        
        .research-icon.locked .level-badge {
            background: #999;
        }
        
        /* Ìà¥ÌåÅ */
        .research-tooltip {
            position: fixed;
            top: 20%;
            transform: translateX(-10%); 
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 99999;
        }
        
        .research-node:hover .research-tooltip {
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        
        .tooltip-level {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .tooltip-costs {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .tooltip-cost {
            font-size: 10px;
            padding: 2px 6px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        
        .tooltip-time {
            font-size: 10px;
            color: #ff9800;
            margin-bottom: 4px;
        }
        
        .tooltip-requirement {
            font-size: 10px;
            color: #f44336;
            padding: 3px 6px;
            background: #ffebee;
            border-radius: 3px;
            margin-top: 4px;
        }
        
        /* Î™®Îã¨ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .research-modal {
            background: white;
            border-radius: 8px;
            padding: 12px;
            height: 150px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 8px;
        }
        
        .modal-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 12px;
            margin-bottom: 6px;
        }
        
        .modal-info-item {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 3px 0;
        }
        
        .modal-label {
            color: #666;
            font-weight: 500;
        }
        
        .modal-value {
            color: #333;
            font-weight: bold;
        }
        
        .modal-costs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        
        .modal-cost-item {
            padding: 3px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            font-size: 11px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-start {
            background: #2196F3;
            color: white;
        }
        
        .btn-start:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .btn-complete {
            background: #4caf50;
            color: white;
        }
        
        .btn-complete:hover:not(:disabled) {
            background: #388e3c;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-cancel:hover:not(:disabled) {
            background: #d32f2f;
        }
        
        .btn-close {
            background: #9e9e9e;
            color: white;
        }
        
        .btn-close:hover {
            background: #757575;
        }
        
        .timer-display {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f0f8ff;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .timer-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            padding: 3px 6px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .timer-item.completed {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .timer-item.running {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }
        
        .result-box {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            display: none;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="game-section"><h3>Research</h3></div>
    
    <div class="container">
        <div class="research-layout">
            <div class="tab-container">
                <button class="tab-button active" onclick="switchTab(1)">Í≤ΩÏ†ú</button>
                <button class="tab-button" onclick="switchTab(2)">Íµ∞ÏÇ¨</button>
            </div>
            
            <div id="timerDisplay" class="timer-display" style="display: none;">
                <strong>ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Íµ¨: </strong>
                <div id="timerItems"></div>
            </div>
            
            <div id="tab1" class="tab-content active">
                <div id="researchTree1" class="research-tree"></div>
            </div>
            
            <div id="tab2" class="tab-content">
                <div id="researchTree2" class="research-tree"></div>
            </div>
            
            <div id="result" class="result-box"></div>
        </div>
    </div>
    
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="research-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Ïó∞Íµ¨ Ï†ïÎ≥¥</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <span class="modal-label">ÌòÑÏû¨</span>
                        <span class="modal-value" id="modalCurrentLevel">0</span>
                    </div>
                    <!-- <div class="modal-info-item">
                        <span class="modal-label">Îã§Ïùå</span>
                        <span class="modal-value" id="modalNextLevel">1</span>
                    </div> -->
                    <div class="modal-info-item">
                        <span class="modal-label">ÏãúÍ∞Ñ</span>
                        <span class="modal-value" id="modalTime">30Ï¥à</span>
                    </div>
                    <div class="modal-info-item">
                        <span class="modal-label">ÏûêÏõê</span>
                    </div>
                </div>
                <div class="modal-costs" id="modalCosts"></div>
                <div id="modalRequirement" style="display: none; margin-top: 6px; padding: 4px 6px; background: #ffebee; border-radius: 3px; color: #f44336; font-size: 10px;"></div>
            </div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        const CURRENT_LANGUAGE_FIELD = 'korean_name';
        
        const researchIcons = {
            1001: 'üí∞', 1011: 'üìâ', 1012: 'üèóÔ∏è', 1013: '‚öóÔ∏è',
            2001: '‚ö°', 2011: '‚öîÔ∏è', 2012: 'üêé', 2013: 'üèπ',
            2021: 'üõ°Ô∏è', 2022: 'üéñÔ∏è', 2023: 'üéØ'
        };
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let researchConfigData = {};  // Ïó∞Íµ¨ ÏÑ§Ï†ï (Í∑∏ÎûòÌîÑ Íµ¨Ï°∞)
        let userResearchData = {};    // Ïú†Ï†Ä ÏßÑÌñâ ÏÉÅÌÉú (API ÏùëÎãµ Í∑∏ÎåÄÎ°ú Ï†ÄÏû•)
        let displayTimer = null;
        let userId = null;
        let currentTab = 1;
        let currentModalData = null;
        let completedResearchChecks = new Set();
        
        // ========================================
        // Ï¥àÍ∏∞Ìôî
        // ========================================
        
        window.onload = function() {
            window.parent.postMessage({
                type: 'request_config',
                configType: 'research'
            }, '*');
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = event.data.userId;
                
                if (userId !== newUserId) {
                    userId = newUserId;
                    
                    if (Object.keys(researchConfigData).length > 0) {
                        loadResearch();
                    }
                }
            }
            
            if (event.data && event.data.type === 'response_config') {
                const researchConfig = event.data.payload;
                researchConfigData = researchConfig;
                
                console.log('üì¶ ConfigData Î°úÎìú ÏôÑÎ£å:', researchConfigData);
                
                if (userId) {
                    loadResearch();
                } else {
                    generateResearchTree();
                }
            }
        });
        
        // ========================================
        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        // ========================================
        
        /**
         * Ïú†Ï†ÄÏùò ÌäπÏ†ï Ïó∞Íµ¨ ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
         * @returns { status, research_lv, end_time } ÎòêÎäî null
         */
        function getUserResearchStatus(researchIdx) {
            return userResearchData[researchIdx] || null;
        }
        
        /**
         * Ïú†Ï†ÄÏùò ÌòÑÏû¨ ÏôÑÎ£åÎêú ÏµúÍ≥† Î†àÎ≤® Í≥ÑÏÇ∞
         */
        function getCurrentCompletedLevel(researchIdx) {
            const userData = getUserResearchStatus(researchIdx);
            
            // status 2 = ÏôÑÎ£å
            if (userData && userData.status === 0) {
                return userData.research_lv;
            }
            
            return 0;
        }
        
        /**
         * Ïú†Ï†ÄÍ∞Ä ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ÏßÄ ÌôïÏù∏
         */
        function isResearchInProgress(researchIdx) {
            const userData = getUserResearchStatus(researchIdx);
            
            // status 1 = ÏßÑÌñâÏ§ë
            return userData && userData.status === 1;
        }
        
        // ========================================
        // UI Ìï®Ïàò
        // ========================================
        
        function switchTab(tabNumber) {
            currentTab = tabNumber;
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach((btn, index) => {
                if (index + 1 === tabNumber) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach((content, index) => {
                if (index + 1 === tabNumber) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        // ========================================
        // ÏãúÍ∞Ñ Í¥ÄÎ†® Ìï®Ïàò
        // ========================================
        
        function parseServerUTCTime(serverTimeString) {
            let utcString = serverTimeString;
            
            if (utcString.includes(' ') && !utcString.includes('T')) {
                utcString = utcString.replace(' ', 'T');
            }
            
            if (!utcString.endsWith('Z') && utcString.includes('T')) {
                utcString += 'Z';
            }
            
            return new Date(utcString);
        }
        
        function calculateUTCTimeDiff(serverUTCTime) {
            const endTime = parseServerUTCTime(serverUTCTime);
            const now = new Date();
            const diff = endTime - now;
            
            const isCompleted = diff <= 0;
            
            const totalSeconds = Math.max(0, Math.floor(diff / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return {
                hours,
                minutes,
                seconds,
                isCompleted,
                format: () => `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
            };
        }
        
        // ========================================
        // ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® Ìï®Ïàò
        // ========================================
        
        function startDisplayTimer() {
            if (displayTimer) {
                return;
            }
            
            console.log('üîÑ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ ÌÉÄÏù¥Î®∏ ÏãúÏûë');
            updateDisplayOnly();
            displayTimer = setInterval(updateDisplayOnly, 1000);
        }
        
        function updateDisplayOnly() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerItems = document.getElementById('timerItems');
            
            if (!timerDisplay || !timerItems) return;
            
            let hasActiveResearch = false;
            timerItems.innerHTML = '';
            
            // ‚úÖ UserDataÎßå ÏàúÌöå (Îã®Ïùº Í∞ùÏ≤¥)
            Object.keys(userResearchData).forEach(researchIdx => {
                const userData = userResearchData[researchIdx];
                
                // status 1(ÏßÑÌñâÏ§ë)Îßå ÌÉÄÏù¥Î®∏ ÌëúÏãú
                if (!userData || userData.status !== 1 || !userData.end_time) {
                    return;
                }
                
                hasActiveResearch = true;
                
                const timeDiff = calculateUTCTimeDiff(userData.end_time);
                
                const timerItem = document.createElement('span');
                timerItem.className = 'timer-item';
                
                // ConfigDataÏóêÏÑú Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
                const configResearch = researchConfigData[researchIdx]?.[userData.research_lv];
                const researchName = configResearch 
                    ? configResearch[CURRENT_LANGUAGE_FIELD] 
                    : `Ïó∞Íµ¨ ${researchIdx}`;
                
                if (!timeDiff.isCompleted) {
                    timerItem.textContent = `${researchName} Lv.${userData.research_lv}: ${timeDiff.format()}`;
                    timerItem.classList.add('running');
                } else {
                    timerItem.textContent = `${researchName} Lv.${userData.research_lv}: ÏôÑÎ£åÎê®`;
                    timerItem.classList.add('completed');
                    
                    completeResearch(parseInt(researchIdx), userData.research_lv);
                }
                
                timerItems.appendChild(timerItem);
            });
            
            timerDisplay.style.display = hasActiveResearch ? 'flex' : 'none';
            
            if (!hasActiveResearch && displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
                console.log('üì∫ ÏßÑÌñâÏ§ëÏù∏ Ïó∞Íµ¨ ÏóÜÏùå - ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ ÌÉÄÏù¥Î®∏ Ï§ëÎã®');
            }
        }
        
        // ========================================
        // API Í¥ÄÎ†® Ìï®Ïàò
        // ========================================
        
        async function completeResearch(researchIdx, level) {
            const researchKey = `${researchIdx}_${level}`;
            
            if (completedResearchChecks.has(researchKey)) {
                return;
            }
            
            completedResearchChecks.add(researchKey);
            
            const configResearch = researchConfigData[researchIdx]?.[level];
            const researchName = configResearch 
                ? configResearch[CURRENT_LANGUAGE_FIELD] 
                : `Ïó∞Íµ¨ ${researchIdx}-${level}`;
            
            console.log(`‚úÖ ${researchName} ÏôÑÎ£å API Ìò∏Ï∂ú`);
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 3003,
                        data: {
                            research_idx: researchIdx,
                            research_lv: level
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`üéâ ${researchName} ÏôÑÎ£å API Í≤∞Í≥º:`, result);
                
                if (result.success) {
                    await loadResearch();
                    showResult(`${researchName} ÏôÑÎ£å! Ïó∞Íµ¨ ÏÑ±Í≥µ`);
                    
                    setTimeout(() => {
                        completedResearchChecks.delete(researchKey);
                    }, 2000);
                } else {
                    showResult(`${researchName} ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                    completedResearchChecks.delete(researchKey);
                }
            } catch (error) {
                console.error(`‚ùå ${researchName} ÏôÑÎ£å API ÏóêÎü¨:`, error);
                showResult(`${researchName} ÏôÑÎ£å Ï≤òÎ¶¨ ÏóêÎü¨: ${error.message}`);
                completedResearchChecks.delete(researchKey);
            }
        }
        
        async function loadResearch() {
            if (!userId) {
                showResult('ÌîåÎ†àÏù¥Ïñ¥ IDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            const previousData = { ...userResearchData };
            userResearchData = {};
            completedResearchChecks.clear();
            
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            
            showResult('Ïó∞Íµ¨ Ï†ïÎ≥¥ Î°úÎî© Ï§ë...');
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 3001,
                        data: {}
                    })
                });
                
                const result = await response.json();
                console.log('üî¨ Ïó∞Íµ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú:', result.data);
                
                if (result.success && result.data) {
                    // ‚úÖ API ÏùëÎãµÏùÑ Í∑∏ÎåÄÎ°ú Ï†ÄÏû•
                    userResearchData = result.data;
                } else {
                    userResearchData = previousData;
                }
            } catch (error) {
                console.log(`Ï†ïÎ≥¥ Î°úÎìú ÏóêÎü¨:`, error);
                userResearchData = previousData;
            }
            
            generateResearchTree();
            startDisplayTimer();
            showResult('Ïó∞Íµ¨ Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å');
        }
        
        async function callAPI(apiCode, researchIdx, level) {
            if (!userId) {
                showResult('ÌîåÎ†àÏù¥Ïñ¥ IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            const configResearch = researchConfigData[researchIdx]?.[level];
            const researchName = configResearch 
                ? configResearch[CURRENT_LANGUAGE_FIELD] 
                : `Ïó∞Íµ¨ ${researchIdx}`;
            
            try {
                showResult(`${researchName} Lv.${level} ÏöîÏ≤≠ Ï§ë...`);
                
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: apiCode,
                        data: {
                            research_idx: researchIdx,
                            research_lv: level
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`üîß ${researchName} API Ìò∏Ï∂ú Í≤∞Í≥º:`, result);
                
                if (result.success) {
                    await loadResearch();
                    
                    if ((apiCode === 3002) && result.data && result.data.status !== 0) {
                        startDisplayTimer();
                    }
                    
                    showResult(`${researchName} Lv.${level} ÏÑ±Í≥µ: ${result.message || 'ÏôÑÎ£å'}`);
                } else {
                    showResult(`${researchName} Lv.${level} Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                }
            } catch (error) {
                console.error(`‚ùå ${researchName} API ÏóêÎü¨:`, error);
                showResult(`${researchName} Lv.${level} ÏóêÎü¨: ${error.message}`);
            }
        }
        
        // ========================================
        // Ïó∞Íµ¨ Ìä∏Î¶¨ ÏÉùÏÑ±
        // ========================================
        
        function generateResearchTree() {
            const tree1 = document.getElementById('researchTree1');
            const tree2 = document.getElementById('researchTree2');
            
            tree1.innerHTML = '';
            tree2.innerHTML = '';
            
            const tab1Research = {};
            const tab2Research = {};
            
            Object.keys(researchConfigData).forEach(researchIdx => {
                const idx = parseInt(researchIdx);
                const firstDigit = Math.floor(idx / 1000);
                
                if (firstDigit === 1) {
                    tab1Research[researchIdx] = researchConfigData[researchIdx];
                } else if (firstDigit === 2) {
                    tab2Research[researchIdx] = researchConfigData[researchIdx];
                }
            });
            
            createResearchNodes(tree1, tab1Research);
            createResearchNodes(tree2, tab2Research);
        }
        
        function createResearchNodes(container, researchGroups) {
            const tierMap = {};
            
            Object.keys(researchGroups).forEach(researchIdx => {
                const researchDic = researchGroups[researchIdx];
                const researchList = Object.values(researchDic);
                
                const tier = parseInt(researchIdx.charAt(researchIdx.length - 2));
                
                if (!tierMap[tier]) {
                    tierMap[tier] = [];
                }
                tierMap[tier].push({ idx: researchIdx, list: researchList });
            });
            
            Object.keys(tierMap).sort((a, b) => a - b).forEach(tier => {
                const tierDiv = document.createElement('div');
                tierDiv.className = 'research-tier';
                tierDiv.value = tier;
                
                const nodesDiv = document.createElement('div');
                nodesDiv.className = 'research-nodes';
                
                tierMap[tier].forEach((research, index) => {
                    const node = createResearchNode(research.idx, research.list);
                    nodesDiv.appendChild(node);
                });
                
                tierDiv.appendChild(nodesDiv);
                container.appendChild(tierDiv);
            });
        }
        
        function createResearchNode(researchIdx, researchList) {
            const node = document.createElement('div');
            node.className = 'research-node';
            
            // ‚úÖ UserDataÏóêÏÑú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞ (Îã®Ïùº Í∞ùÏ≤¥)
            const currentLevel = getCurrentCompletedLevel(researchIdx);
            const hasInProgress = isResearchInProgress(researchIdx);
            
            const nextLevel = hasInProgress ? currentLevel : currentLevel + 1;
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            const icon = document.createElement('div');
            icon.className = 'research-icon';
            icon.textContent = researchIcons[researchIdx] || 'üî¨';
            
            if (currentLevel === maxLevel) {
                icon.classList.add('completed');
            } else if (hasInProgress) {
                icon.classList.add('in-progress');
            } else if (!checkRequirements(research.required_researchs)) {
                icon.classList.add('locked');
            } else {
                icon.classList.add('available');
            }
            
            const badge = document.createElement('div');
            badge.className = 'level-badge';
            badge.textContent = `${currentLevel}/${maxLevel}`;
            icon.appendChild(badge);
            
            node.appendChild(icon);
            
            const tooltip = createTooltip(researchIdx, researchList, currentLevel, nextLevel);
            node.appendChild(tooltip);
            
            node.onclick = function(e) {
                e.stopPropagation();
                if (!icon.classList.contains('locked') || currentLevel > 0) {
                    openModal(researchIdx, researchList, currentLevel, nextLevel, hasInProgress);
                }
            };
            
            return node;
        }
        
        function createTooltip(researchIdx, researchList, currentLevel, nextLevel) {
            const tooltip = document.createElement('div');
            tooltip.className = 'research-tooltip';
            
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            const title = document.createElement('div');
            title.className = 'tooltip-title';
            title.textContent = research[CURRENT_LANGUAGE_FIELD];
            tooltip.appendChild(title);
            
            const level = document.createElement('div');
            level.className = 'tooltip-level';
            level.textContent = `ÌòÑÏû¨ Î†àÎ≤®: ${currentLevel} / ${maxLevel}`;
            tooltip.appendChild(level);
            
            if (currentLevel < maxLevel) {
                const costs = document.createElement('div');
                costs.className = 'tooltip-costs';
                const cost_dic = research.cost;
                
                if (cost_dic.food > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `üåæ ${cost_dic.food}`;
                    costs.appendChild(cost);
                }
                if (cost_dic.wood > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ü™µ ${cost_dic.wood}`;
                    costs.appendChild(cost);
                }
                if (cost_dic.stone > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ü™® ${cost_dic.stone}`;
                    costs.appendChild(cost);
                }
                if (cost_dic.gold > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `üí∞ ${cost_dic.gold}`;
                    costs.appendChild(cost);
                }
                
                tooltip.appendChild(costs);
                
                const time = document.createElement('div');
                time.className = 'tooltip-time';
                time.textContent = `‚è±Ô∏è ${research.time}Ï¥à`;
                tooltip.appendChild(time);
                
                const reqDataList = getRequiredResearch(research.required_researchs);
                if (reqDataList && reqDataList.length > 0) {
                    for (const reqData of reqDataList) {
                        if (reqData && typeof reqData === 'object' && reqData.idx && reqData.lv !== undefined) {
                            const req = document.createElement('div');
                            req.className = 'tooltip-requirement';
                            req.textContent = `ÌïÑÏöî: Ïó∞Íµ¨ ${reqData.idx} Lv.${reqData.lv}`;
                            tooltip.appendChild(req);
                        }
                    }
                }
            }
            
            return tooltip;
        }
        
        // ========================================
        // ÌïÑÏàò Ï°∞Í±¥ Ï≤¥ÌÅ¨
        // ========================================
        
        function getRequiredResearch(required) {
            if (!required) return [];
            
            const results = [];
            
            if (Array.isArray(required)) {
                if (required.length === 0) return [];
                
                if (Array.isArray(required[0])) {
                    for (const item of required) {
                        if (Array.isArray(item) && item.length >= 2) {
                            results.push({
                                idx: item[0],
                                lv: item[1]
                            });
                        }
                    }
                    return results;
                }
                
                if (typeof required[0] === 'number' && required.length >= 2) {
                    return [{
                        idx: required[0],
                        lv: required[1]
                    }];
                }
                
                if (typeof required[0] === 'string') {
                    return getRequiredResearch(required[0]);
                }
            }
            
            if (typeof required === 'string') {
                const trimmed = required.trim();
                if (trimmed === '') return [];
                
                const parts = trimmed.split(':');
                if (parts.length >= 2) {
                    return [{
                        idx: parseInt(parts[0]),
                        lv: parseInt(parts[1])
                    }];
                }
            }
            
            return [];
        }
        
        function checkRequirements(requiredResearchs) {
            const reqDataList = getRequiredResearch(requiredResearchs);
            if (!reqDataList || reqDataList.length === 0) return true;
            
            for (const reqData of reqDataList) {
                if (typeof reqData !== 'object' || !reqData.idx || reqData.lv === undefined) {
                    console.error("‚ùå reqDataÍ∞Ä Ïò¨Î∞îÎ•∏ ÌòïÌÉúÍ∞Ä ÏïÑÎãôÎãàÎã§:", reqData);
                    return false;
                }
                
                const reqIdx = reqData.idx;
                const reqLv = reqData.lv;
                
                // ‚úÖ UserDataÏóêÏÑú ÌôïÏù∏ (Îã®Ïùº Í∞ùÏ≤¥)
                const userData = getUserResearchStatus(reqIdx);
                
                // ÏöîÍµ¨ÏÇ¨Ìï≠: Ìï¥Îãπ Î†àÎ≤®Ïù¥ ÏôÑÎ£åÎêòÏñ¥ ÏûàÏñ¥Ïïº Ìï®
                if (!userData || userData.research_lv < reqLv || userData.status !== 2) {
                    return false;
                }
            }
            
            return true;
        }
        
        // ========================================
        // Î™®Îã¨
        // ========================================
        
        function openModal(researchIdx, researchList, currentLevel, nextLevel, hasInProgress) {
            const modal = document.getElementById('modalOverlay');
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            currentModalData = { researchIdx, nextLevel, hasInProgress };
            
            document.getElementById('modalTitle').textContent = research[CURRENT_LANGUAGE_FIELD];
            document.getElementById('modalCurrentLevel').textContent = `${currentLevel} / ${maxLevel}`;
            //document.getElementById('modalNextLevel').textContent = currentLevel < maxLevel ? nextLevel : 'ÏµúÎåÄ Î†àÎ≤®';
            document.getElementById('modalTime').textContent = `${research.time}Ï¥à`;
            
            const costsDiv = document.getElementById('modalCosts');
            costsDiv.innerHTML = '';
            
            const cost_dic = research.cost;
            
            if (cost_dic.food > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `üåæ ${cost_dic.food}`;
                costsDiv.appendChild(cost);
            }
            if (cost_dic.wood > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ü™µ ${cost_dic.wood}`;
                costsDiv.appendChild(cost);
            }
            if (cost_dic.stone > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ü™® ${cost_dic.stone}`;
                costsDiv.appendChild(cost);
            }
            if (cost_dic.gold > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `üí∞ ${cost_dic.gold}`;
                costsDiv.appendChild(cost);
            }
            
            const reqDiv = document.getElementById('modalRequirement');
            const reqDataList = getRequiredResearch(research.required_researchs);
            if (reqDataList && reqDataList.length > 0) {
                const reqTexts = reqDataList.map(reqData => 
                    `${reqData.idx}-${reqData.lv}`
                ).join(', ');
                reqDiv.textContent = `‚ö†Ô∏è ÌïÑÏöî: ${reqTexts}`;

                reqDiv.style.display = 'block';
            } else {
                reqDiv.style.display = 'none';
            }
            
            const buttonsDiv = document.getElementById('modalButtons');
            buttonsDiv.innerHTML = '';
            
            const canStart = !hasInProgress && currentLevel < maxLevel && checkRequirements(research.required_researchs);
            const userData = getUserResearchStatus(researchIdx);
            
            if (hasInProgress && userData && userData.status === 1) {
                const completeBtn = document.createElement('button');
                completeBtn.textContent = 'Ï¶âÏãúÏôÑÎ£å';
                completeBtn.className = 'btn-complete';
                completeBtn.onclick = () => {
                    closeModal();
                    callAPI(3003, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(completeBtn);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Ï∑®ÏÜå';
                cancelBtn.className = 'btn-cancel';
                cancelBtn.onclick = () => {
                    closeModal();
                    callAPI(3004, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(cancelBtn);
            } else if (currentLevel === maxLevel) {
                const completedBtn = document.createElement('button');
                completedBtn.textContent = 'Ïó∞Íµ¨ ÏôÑÎ£å';
                completedBtn.className = 'btn-close';
                completedBtn.onclick = closeModal;
                buttonsDiv.appendChild(completedBtn);
            } else {
                const startBtn = document.createElement('button');
                startBtn.textContent = 'Ïó∞Íµ¨ ÏãúÏûë';
                startBtn.className = 'btn-start';
                startBtn.disabled = !canStart;
                startBtn.onclick = () => {
                    closeModal();
                    callAPI(3002, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(startBtn);
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Îã´Í∏∞';
                closeBtn.className = 'btn-close';
                closeBtn.onclick = closeModal;
                buttonsDiv.appendChild(closeBtn);
            }
            
            modal.classList.add('active');
        }
        
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            currentModalData = null;
        }
        
        // ========================================
        // Ïú†Ìã∏Î¶¨Ìã∞
        // ========================================
        
        function showResult(message) {

            //Ïû†ÏãúÏÇ¨Ïö©ÏïàÌï®
            // const resultBox = document.getElementById('result');
            // resultBox.style.display = 'block';
            // resultBox.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            // console.log(`üì¢ ${message}`);
        }
        
        // ========================================
        // ÌéòÏù¥ÏßÄ Ïù¥Î≤§Ìä∏
        // ========================================
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÄ ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî - ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïû¨ÏãúÏûë');
                startDisplayTimer();
            } else {
                console.log('üò¥ ÌéòÏù¥ÏßÄ ÎπÑÌôúÏÑ±Ìôî');
            }
        });
        
        window.onbeforeunload = function() {
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            console.log('üîÑ ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å - ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨');
        };
    </script>
</body>
</html>