<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°êµ¬ ê´€ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            padding: 10px;
            
            margin: 0;
        }
        .game-section h3 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        .container {
            max-width: 100%;
            margin: 0;
        }
        strong {
            margin-right: 10px;
        }
        
        /* 1. ìƒˆë¡œìš´ ì „ì²´ ë ˆì´ì•„ì›ƒ (íƒ­ + ë‚´ìš©) */
        .research-layout {
            display: flex; /* ì™¼ìª½ íƒ­ê³¼ ì˜¤ë¥¸ìª½ ë‚´ìš© ì˜ì—­ì„ ë‚˜ë€íˆ ë°°ì¹˜ */
            gap: 15px;
            height: 70vh; /* íƒ­ ì˜ì—­ ë†’ì´ ì§€ì • */
        }

        /* 2. íƒ­ ì»¨í…Œì´ë„ˆ (ì™¼ìª½ ì„¸ë¡œ) */
        .tab-container {
            display: flex;
            flex-direction: column; /* ì•„ì´í…œì„ ì„¸ë¡œë¡œ ì •ë ¬ */
            gap: 5px;
            padding-right: 10px;
            border-right: 2px solid #ddd; /* ì˜¤ë¥¸ìª½ ê²½ê³„ì„ ìœ¼ë¡œ ë³€ê²½ */
            margin-bottom: 0;
            min-width: 50px; /* íƒ­ ë²„íŠ¼ì´ ì¶©ë¶„íˆ ë³´ì´ë„ë¡ ë„ˆë¹„ ì„¤ì • */
        }

        /* 3. íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-right: none; /* ì˜¤ë¥¸ìª½ ì„  ì œê±° */
            background: #f5f5f5;
            cursor: pointer;
            text-align: left; /* í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
            border-radius: 4px 0 0 4px; /* ì™¼ìª½ ëª¨ì„œë¦¬ë§Œ ë‘¥ê¸€ê²Œ */
        }

        .tab-button.active {
            background-color: white;
            font-weight: bold;
            border-color: #ddd;
            border-right: none; /* í™œì„±í™” ì‹œ ì˜¤ë¥¸ìª½ ì„  ì—†ì•° */
        }

        /* 4. íƒ­ ë‚´ìš© ì»¨í…Œì´ë„ˆ */
        .tab-content-container {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ë‚´ìš© ì˜ì—­ì´ ëª¨ë‘ ì°¨ì§€ */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            padding-left: 10px;
        }

        /* ê¸°íƒ€ í•„ìš”í•œ ìŠ¤íƒ€ì¼ ì¡°ì • */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        
        /* ì—°êµ¬ íŠ¸ë¦¬ ìŠ¤íƒ€ì¼ */
        .research-tree {
            position: relative;
            padding: 10px;
            background: white;
            border-radius: 8px;
            
            /*border: 1px solid #ddd;*/
            display: flex;
            
        }
        
        .research-tier {
            
            align-items: center;
            /*margin-bottom: 60px;*/
            position: relative;
            
            
        }
        
        .tier-label {
            min-width: 80px;
            font-weight: bold;
            color: #555;
            font-size: 13px;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 4px;
            text-align: center;
        }
        
        .research-list {
        display: flex;
        flex-wrap: wrap; /* ì•„ì´í…œì´ ë„˜ì¹  ê²½ìš° ë‹¤ìŒ ì¤„ë¡œ ë„˜ì–´ê° */
        gap: 15px; /* ì•„ì´í…œ ê°„ ê°„ê²© ì„¤ì • */
        padding: 10px 0;
        }

        .research-item {
            border: 1px solid #eee;
            padding: 10px;
            width: calc(33.333% - 10px); /* í•œ ì¤„ì— 3ê°œ ì•„ì´í…œ (33.333% - gap) */
            box-sizing: border-box;
            border-radius: 4px;
            background-color: white;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.05);
            /* í•„ìš”ì— ë”°ë¼ ì•„ì´í…œì˜ ìµœì†Œ ë„ˆë¹„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. */
            min-width: 150px; 
        }

        .research-item h4 {
            margin-top: 0;
            font-size: 14px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }


        .research-nodes {
            gap: 40px;
            flex: 1;
            align-items: center;
            justify-content: flex-start;
            margin-left: 30px;
            
        }
        
        /* ì—°êµ¬ ë…¸ë“œ (ì•„ì´ì½˜) */
        .research-node {
            position: relative;
            cursor: pointer;
            z-index: 10;
            margin-bottom: 5px;
        }

        
        .research-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 3px solid #ddd;
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .research-node:hover .research-icon {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .research-icon.completed {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }
        
        .research-icon.in-progress {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .research-icon.locked {
            border-color: #bbb;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .research-icon.available {
            border-color: #2196F3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
        }
        
        /* ë ˆë²¨ ë±ƒì§€ */
        .level-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .research-icon.completed .level-badge {
            background: #4caf50;
        }
        
        .research-icon.locked .level-badge {
            background: #999;
        }
        
        /* í˜¸ë²„ íˆ´íŒ */
        .research-tooltip {
            position: fixed;
            top: 20%;
            /* left: 20%; */
            /* transform: translateY(-50%); */
            transform: translateX(-10%); 
            /* left: auto; */
            
            
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 99999;
        }
        
        .research-node:hover .research-tooltip {
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        
        .tooltip-level {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }
        
        .tooltip-costs {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .tooltip-cost {
            font-size: 10px;
            padding: 2px 6px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        
        .tooltip-time {
            font-size: 10px;
            color: #ff9800;
            margin-bottom: 4px;
        }
        
        .tooltip-requirement {
            font-size: 10px;
            color: #f44336;
            padding: 3px 6px;
            background: #ffebee;
            border-radius: 3px;
            margin-top: 4px;
        }
        
        /* ì—°ê²°ì„  */
        .connection-line {
            position: absolute;
            height: 3px;
            background: #ddd;
            transform-origin: left center;
            z-index: 1;
        }
        
        .connection-line.active {
            background: linear-gradient(90deg, #4caf50, #81c784);
        }
        
        .connection-line.partial {
            background: linear-gradient(90deg, #4caf50, #ddd);
        }
        
        /* íŒì—… ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .research-modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
            z-index: 9999;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .modal-content {
            margin-bottom: 15px;
        }
        
        .modal-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .modal-label {
            color: #666;
            font-weight: 500;
        }
        
        .modal-value {
            color: #333;
            font-weight: bold;
        }
        
        .modal-costs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .modal-cost-item {
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-size: 13px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-start {
            background: #2196F3;
            color: white;
        }
        
        .btn-start:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .btn-complete {
            background: #4caf50;
            color: white;
        }
        
        .btn-complete:hover:not(:disabled) {
            background: #388e3c;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-cancel:hover:not(:disabled) {
            background: #d32f2f;
        }
        
        .btn-close {
            background: #9e9e9e;
            color: white;
        }
        
        .btn-close:hover {
            background: #757575;
        }
        
        .timer-display {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f0f8ff;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .timer-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            padding: 3px 6px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .timer-item.completed {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .timer-item.running {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }
        
        .result-box {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            display: none;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="game-section"><h3>Research</h3></div>
    
    <div class="container">
        <div class="research-layout">
            <!-- íƒ­ ë²„íŠ¼ -->
            <div class="tab-container">
                <button class="tab-button active" onclick="switchTab(1)">ê²½ì œ</button>
                <button class="tab-button" onclick="switchTab(2)">êµ°ì‚¬</button>
            </div>
            
            <!-- íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ -->
            <div id="timerDisplay" class="timer-display" style="display: none;">
                <strong>ì§„í–‰ ì¤‘ì¸ ì—°êµ¬: </strong>
                <div id="timerItems"></div>
            </div>
            
            <!-- íƒ­ 1: ê²½ì œ -->
            <div id="tab1" class="tab-content active">
                <div id="researchTree1" class="research-tree"></div>
            </div>
            
            <!-- íƒ­ 2: êµ°ì‚¬ -->
            <div id="tab2" class="tab-content">
                <div id="researchTree2" class="research-tree"></div>
            </div>
            
            <div id="result" class="result-box"></div>
        </div>
    </div>
    
    <!-- ì—°êµ¬ íŒì—… ëª¨ë‹¬ -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="research-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ì—°êµ¬ ì •ë³´</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-info-row">
                    <span class="modal-label">í˜„ì¬ ë ˆë²¨</span>
                    <span class="modal-value" id="modalCurrentLevel">0</span>
                </div>
                <div class="modal-info-row">
                    <span class="modal-label">ë‹¤ìŒ ë ˆë²¨</span>
                    <span class="modal-value" id="modalNextLevel">1</span>
                </div>
                <div class="modal-info-row">
                    <span class="modal-label">ì—°êµ¬ ì‹œê°„</span>
                    <span class="modal-value" id="modalTime">30ì´ˆ</span>
                </div>
                <div class="modal-info-row">
                    <span class="modal-label">í•„ìš” ìì›</span>
                </div>
                <div class="modal-costs" id="modalCosts"></div>
                <div id="modalRequirement" style="display: none; margin-top: 10px; padding: 8px; background: #ffebee; border-radius: 4px; color: #f44336; font-size: 12px;"></div>
            </div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        // â­ ë‹¤êµ­ì–´ ì„¤ì •ì„ ìœ„í•œ ìƒìˆ˜
        const CURRENT_LANGUAGE_FIELD = 'korean_name';
        
        // ì—°êµ¬ ì•„ì´ì½˜ ë§¤í•‘ (ì—°êµ¬ ì¢…ë¥˜ë³„ë¡œ ë‹¤ë¥¸ ì•„ì´ì½˜ ì‚¬ìš©)
        const researchIcons = {
            1001: 'ğŸ’°', // ìì›íšë“
            1011: 'ğŸ“‰', // ìì›ì‚¬ìš©ëŸ‰
            1012: 'ğŸ—ï¸', // ê±´ë¬¼ì‹œê°„
            1013: 'âš—ï¸', // ì—°êµ¬ì‹œê°„
            2001: 'âš¡', // ë³‘ì‚¬ì†ë„
            2011: 'âš”ï¸', // ë³´ë³‘ê³µê²©ë ¥
            2012: 'ğŸ', // ê¸°ë³‘ê³µê²©ë ¥
            2013: 'ğŸ¹', // ê¶ë³‘ê³µê²©ë ¥
            2021: 'ğŸ›¡ï¸', // ë³´ë³‘ 2í‹°ì–´
            2022: 'ğŸ–ï¸', // ê¸°ë³‘ 2í‹°ì–´
            2023: 'ğŸ¯'  // ê¶ë³‘ 2í‹°ì–´
        };
        
        // ë”ë¯¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” JSONìœ¼ë¡œ ë°›ì•„ì˜¬ ì˜ˆì •)
        const dummyResearchData = {
        // 1001 ê³„ì—´ (Resource Production)
        '1001': {
            1: { buff_idx: 101, research_lv: 1, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '', english_name: 'Resource Production I', korean_name: 'ìì›íšë“+' },
            2: { buff_idx: 102, research_lv: 2, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '', english_name: 'Resource Production II', korean_name: 'ìì›íšë“+' },
            3: { buff_idx: 103, research_lv: 3, research_time: 60, food: 400, wood: 0, stone: 0, gold: 400, required_researchs: '', english_name: 'Resource Production III', korean_name: 'ìì›íšë“+' }
        },
        
        // 1011 ê³„ì—´ (Resource Usage)
        '1011': {
            1: { buff_idx: 104, research_lv: 1, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '1001:3', english_name: 'Resource Usage I', korean_name: 'ìì›ì‚¬ìš©ëŸ‰-' },
            2: { buff_idx: 105, research_lv: 2, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '1001:3', english_name: 'Resource Usage II', korean_name: 'ìì›ì‚¬ìš©ëŸ‰-' }
        },
        
        // 1012 ê³„ì—´ (Build Time)
        '1012': {
            1: { buff_idx: 106, research_lv: 1, research_time: 60, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '1001:3', english_name: 'Build Time I', korean_name: 'ê±´ë¬¼ì‹œê°„-' },
            2: { buff_idx: 107, research_lv: 2, research_time: 20, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '1001:3', english_name: 'Build Time II', korean_name: 'ê±´ë¬¼ì‹œê°„-' }
        },
        
        // 1013 ê³„ì—´ (Research Time)
        '1013': {
            1: { buff_idx: 108, research_lv: 1, research_time: 40, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '1001:3', english_name: 'Research Time I', korean_name: 'ì—°êµ¬ì‹œê°„-' },
            2: { buff_idx: 109, research_lv: 2, research_time: 60, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '1001:3', english_name: 'Research Time II', korean_name: 'ì—°êµ¬ì‹œê°„-' }
        },
        
        // 2001 ê³„ì—´ (Soldier Speed)
        '2001': {
            1: { buff_idx: 201, research_lv: 1, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '', english_name: 'Soldier Speed I', korean_name: 'ë³‘ì‚¬ì†ë„+' },
            2: { buff_idx: 202, research_lv: 2, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '', english_name: 'Soldier Speed II', korean_name: 'ë³‘ì‚¬ì†ë„+' },
            3: { buff_idx: 203, research_lv: 3, research_time: 60, food: 400, wood: 0, stone: 0, gold: 400, required_researchs: '', english_name: 'Soldier Speed III', korean_name: 'ë³‘ì‚¬ì†ë„+' }
        },
        
        // 2011 ê³„ì—´ (Infantry Attack)
        '2011': {
            1: { buff_idx: 204, research_lv: 1, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '2001:3', english_name: 'Infantry Attack I', korean_name: 'ë³´ë³‘ê³µê²©ë ¥+' },
            2: { buff_idx: 205, research_lv: 2, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '2001:3', english_name: 'Infantry Attack II', korean_name: 'ë³´ë³‘ê³µê²©ë ¥+' }
        },
        
        // 2012 ê³„ì—´ (Cavalry Attack)
        '2012': {
            1: { buff_idx: 206, research_lv: 1, research_time: 60, food: 400, wood: 0, stone: 0, gold: 400, required_researchs: '2001:3', english_name: 'Cavalry Attack I', korean_name: 'ê¸°ë³‘ê³µê²©ë ¥+' },
            2: { buff_idx: 207, research_lv: 2, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '2001:3', english_name: 'Cavalry Attack II', korean_name: 'ê¸°ë³‘ê³µê²©ë ¥+' }
        },
        
        // 2013 ê³„ì—´ (Archer Attack)
        '2013': {
            1: { buff_idx: 208, research_lv: 1, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '2001:3', english_name: 'Archer Attack I', korean_name: 'ê¶ë³‘ê³µê²©ë ¥+' },
            2: { buff_idx: 209, research_lv: 2, research_time: 60, food: 400, wood: 0, stone: 0, gold: 400, required_researchs: '2001:3', english_name: 'Archer Attack II', korean_name: 'ê¶ë³‘ê³µê²©ë ¥+' }
        },
        
        // 2021 ê³„ì—´ (Infantry Tier 2)
        '2021': {
            1: { buff_idx: 210, research_lv: 1, research_time: 20, food: 100, wood: 0, stone: 0, gold: 100, required_researchs: '2011:2', english_name: 'Infantry Tier 2', korean_name: 'ë³´ë³‘ 2í‹°ì–´' }
        },
        
        // 2022 ê³„ì—´ (Cavalry Tier 2)
        '2022': {
            1: { buff_idx: 211, research_lv: 1, research_time: 40, food: 200, wood: 0, stone: 0, gold: 200, required_researchs: '2012:2', english_name: 'Cavalry Tier 2', korean_name: 'ê¸°ë³‘ 2í‹°ì–´' }
        },
        
        // 2023 ê³„ì—´ (Archer Tier 2)
        '2023': {
            1: { buff_idx: 212, research_lv: 1, research_time: 60, food: 400, wood: 0, stone: 0, gold: 400, required_researchs: '2013:2', english_name: 'Archer Tier 2', korean_name: 'ê¶ë³‘ 2í‹°ì–´' }
        }
    };


        
        let researchConfigData = dummyResearchData;
        let userResearchData = {};
        let displayTimer = null;
        let userId = null;
        let currentTab = 1;
        let currentModalData = null;
        
        let completedResearchChecks = new Set();
        
        window.onload = function() {
            window.parent.postMessage({
                type: 'request_config',
                configType: 'research'
            }, '*');
            generateResearchTree();
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = event.data.userId;
                
                if (userId !== newUserId) {
                    userId = newUserId;
                    
                    if (Object.keys(researchConfigData).length > 0) {
                        loadResearch();
                    }
                }
            }
            
            if (event.data && event.data.type === 'response_config') {
                const researchConfig = event.data.payload;
                researchConfigData = researchConfig;
                console.log('Research data received:', researchConfigData);
                
                if (userId) {
                    loadResearch();
                } else {
                    //generateResearchTree();
                }
            }
        });
        
        function switchTab(tabNumber) {
            currentTab = tabNumber;
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach((btn, index) => {
                if (index + 1 === tabNumber) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach((content, index) => {
                if (index + 1 === tabNumber) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        function parseServerUTCTime(serverTimeString) {
            let utcString = serverTimeString;
            
            if (utcString.includes(' ') && !utcString.includes('T')) {
                utcString = utcString.replace(' ', 'T');
            }
            
            if (!utcString.endsWith('Z') && utcString.includes('T')) {
                utcString += 'Z';
            }
            
            return new Date(utcString);
        }
        
        function calculateUTCTimeDiff(serverUTCTime) {
            const endTime = parseServerUTCTime(serverUTCTime);
            const now = new Date();
            const diff = endTime - now;
            
            const isCompleted = diff <= 0;
            
            const totalSeconds = Math.max(0, Math.floor(diff / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return {
                hours,
                minutes,
                seconds,
                isCompleted,
                format: () => `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
            };
        }
        
        function startDisplayTimer() {
            if (displayTimer) {
                return;
            }
            
            console.log('ğŸ”„ í™”ë©´ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì‹œì‘');
            updateDisplayOnly();
            displayTimer = setInterval(updateDisplayOnly, 1000);
        }
        
        async function completeResearch(researchIdx, level) {
            const researchKey = `${researchIdx}_${level}`;
            
            if (completedResearchChecks.has(researchKey)) {
                return;
            }
            
            completedResearchChecks.add(researchKey);
            
            const researchList = researchConfigData[researchIdx];
            const research = researchList ? researchList.find(r => r.research_lv === level) : null;
            const researchName = research ? research[CURRENT_LANGUAGE_FIELD] : `ì—°êµ¬ ${researchIdx}-${level}`;
            
            console.log(`âœ… ${researchName} ì™„ë£Œ API í˜¸ì¶œ`);
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 3003,
                        data: {
                            research_idx: researchIdx,
                            research_lv: level
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`ğŸ‰ ${researchName} ì™„ë£Œ API ê²°ê³¼:`, result);
                
                if (result.success) {
                    if (result.data) {
                        if (!userResearchData[researchIdx]) {
                            userResearchData[researchIdx] = {};
                        }
                        userResearchData[researchIdx][level] = result.data;
                    }
                    
                    await loadResearch();
                    showResult(`${researchName} ì™„ë£Œ! ì—°êµ¬ ì„±ê³µ`);
                    
                    setTimeout(() => {
                        completedResearchChecks.delete(researchKey);
                    }, 2000);
                } else {
                    showResult(`${researchName} ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    completedResearchChecks.delete(researchKey);
                }
            } catch (error) {
                console.error(`âŒ ${researchName} ì™„ë£Œ API ì—ëŸ¬:`, error);
                showResult(`${researchName} ì™„ë£Œ ì²˜ë¦¬ ì—ëŸ¬: ${error.message}`);
                completedResearchChecks.delete(researchKey);
            }
        }
        
        function updateDisplayOnly() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerItems = document.getElementById('timerItems');
            
            if (!timerDisplay || !timerItems) return;
            
            let hasActiveResearch = false;
            timerItems.innerHTML = '';
            
            Object.keys(researchConfigData).forEach(researchIdx => {
                const researchList = researchConfigData[researchIdx];
                
                researchList.forEach(research => {
                    const userData = userResearchData[researchIdx]?.[research.research_lv];
                    
                    if (!userData || userData.status === 0 || !userData.end_time) {
                        return;
                    }
                    
                    hasActiveResearch = true;
                    
                    const timeDiff = calculateUTCTimeDiff(userData.end_time);
                    
                    const timerItem = document.createElement('span');
                    timerItem.className = 'timer-item';
                    
                    const researchName = research[CURRENT_LANGUAGE_FIELD];
                    
                    if (!timeDiff.isCompleted) {
                        timerItem.textContent = `${researchName} Lv.${research.research_lv}: ${timeDiff.format()}`;
                        timerItem.classList.add('running');
                    } else {
                        timerItem.textContent = `${researchName} Lv.${research.research_lv}: ì™„ë£Œë¨`;
                        timerItem.classList.add('completed');
                        
                        completeResearch(parseInt(researchIdx), research.research_lv);
                    }
                    
                    timerItems.appendChild(timerItem);
                });
            });
            
            timerDisplay.style.display = hasActiveResearch ? 'flex' : 'none';
            
            if (!hasActiveResearch && displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
                console.log('ğŸ“º ì§„í–‰ì¤‘ì¸ ì—°êµ¬ ì—†ìŒ - í™”ë©´ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì¤‘ë‹¨');
            }
        }
        
        async function loadResearch() {
            if (!userId) {
                showResult('í”Œë ˆì´ì–´ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const previousData = { ...userResearchData };
            userResearchData = {};
            completedResearchChecks.clear();
            
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            
            showResult('ì—°êµ¬ ì •ë³´ ë¡œë”© ì¤‘...');
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 3001,
                        data: {}
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ”¬ ì—°êµ¬ ë°ì´í„° ë¡œë“œ:', result.data);
                
                if (result.success && result.data) {
                    userResearchData = result.data;
                } else {
                    userResearchData = previousData;
                }
            } catch (error) {
                console.log(`ì •ë³´ ë¡œë“œ ì—ëŸ¬:`, error);
                userResearchData = previousData;
            }
            
            generateResearchTree();
            showResult('ì—°êµ¬ ì •ë³´ ë¡œë“œ ì™„ë£Œ');
        }
        
        function generateResearchTree() {
            const tree1 = document.getElementById('researchTree1');
            const tree2 = document.getElementById('researchTree2');
            
            tree1.innerHTML = '';
            tree2.innerHTML = '';
            
            const tab1Research = {};
            const tab2Research = {};
            
            Object.keys(researchConfigData).forEach(researchIdx => {
                const idx = parseInt(researchIdx);
                const firstDigit = Math.floor(idx / 1000);
                
                if (firstDigit === 1) {
                    tab1Research[researchIdx] = researchConfigData[researchIdx];
                } else if (firstDigit === 2) {
                    tab2Research[researchIdx] = researchConfigData[researchIdx];
                }
            });
            
            createResearchNodes(tree1, tab1Research);
            createResearchNodes(tree2, tab2Research);
        }
        
        function createResearchNodes(container, researchGroups) {
            const tierMap = {};
            
            Object.keys(researchGroups).forEach(researchIdx => {
                const researchDic = researchGroups[researchIdx];

                const researchList = Object.values(researchDic);

                
                const firstResearch = researchList[0];
                
                let tier = 1;
                // if (firstResearch.required_researchs && firstResearch.required_researchs.trim() !== '') {
                //     const requiredIdx = parseInt(firstResearch.required_researchs.split(':')[0]);
                //     const baseIdx = Math.floor(requiredIdx / 10) * 10;
                    
                //     if (baseIdx === Math.floor(parseInt(researchIdx) / 100) * 100 + 1) {
                //         tier = 2;
                //     } else {
                //         tier = 3;
                //     }
                // }
                
                tier = parseInt(researchIdx.charAt(researchIdx.length-2))
                if (!tierMap[tier]) {
                    tierMap[tier] = [];
                }
                tierMap[tier].push({ idx: researchIdx, list: researchList });
            });
            
            Object.keys(tierMap).sort((a, b) => a - b).forEach(tier => {
                const tierDiv = document.createElement('div');
                tierDiv.className = 'research-tier';
                tierDiv.value = tier
                // const label = document.createElement('div');
                // label.className = 'tier-label';
                // label.textContent = `Tier ${tier}`;
                // tierDiv.appendChild(label);
                
                const nodesDiv = document.createElement('div');
                nodesDiv.className = 'research-nodes';
                
                tierMap[tier].forEach((research, index) => {
                    const node = createResearchNode(research.idx, research.list);
                    nodesDiv.appendChild(node);
                    
                    // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                    if (tier > 1 && research.list[0].required_researchs) {
                        drawConnectionLine(container, research.idx, research.list[0].required_researchs);
                    }
                });
                
                tierDiv.appendChild(nodesDiv);
                container.appendChild(tierDiv);
            });
        }
        
        function createResearchNode(researchIdx, researchList) {
            const node = document.createElement('div');
            node.className = 'research-node';
            
            let currentLevel = 0;
            let hasInProgress = false;
            
            if (userResearchData[researchIdx]) {
                Object.keys(userResearchData[researchIdx]).forEach(lv => {
                    const data = userResearchData[researchIdx][lv];
                    if (data.status === 2) {
                        currentLevel = Math.max(currentLevel, parseInt(lv));
                    } else if (data.status === 1) {
                        hasInProgress = true;
                    }
                });
            }
            
            const nextLevel = hasInProgress ? currentLevel : currentLevel + 1;
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            const icon = document.createElement('div');
            icon.className = 'research-icon';
            icon.textContent = researchIcons[researchIdx] || 'ğŸ”¬';
            
            if (currentLevel === maxLevel) {
                icon.classList.add('completed');
            } else if (hasInProgress) {
                icon.classList.add('in-progress');
            } else if (!checkRequirements(research.required_researchs)) {
                icon.classList.add('locked');
            } else {
                icon.classList.add('available');
            }
            
            const badge = document.createElement('div');
            badge.className = 'level-badge';
            badge.textContent = `${currentLevel}/${maxLevel}`;
            icon.appendChild(badge);
            
            node.appendChild(icon);
            
            const tooltip = createTooltip(researchIdx, researchList, currentLevel, nextLevel);
            node.appendChild(tooltip);
            
            node.onclick = function(e) {
                e.stopPropagation();
                if (!icon.classList.contains('locked') || currentLevel > 0) {
                    openModal(researchIdx, researchList, currentLevel, nextLevel, hasInProgress);
                }
            };
            
            return node;
        }
        
        function createTooltip(researchIdx, researchList, currentLevel, nextLevel) {
            const tooltip = document.createElement('div');
            tooltip.className = 'research-tooltip';
            
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            const title = document.createElement('div');
            title.className = 'tooltip-title';
            title.textContent = research[CURRENT_LANGUAGE_FIELD];
            tooltip.appendChild(title);
            
            const level = document.createElement('div');
            level.className = 'tooltip-level';
            level.textContent = `í˜„ì¬ ë ˆë²¨: ${currentLevel} / ${maxLevel}`;
            tooltip.appendChild(level);
            
            if (currentLevel < maxLevel) {
                const costs = document.createElement('div');
                costs.className = 'tooltip-costs';
                
                if (research.food > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ğŸŒ¾ ${research.food}`;
                    costs.appendChild(cost);
                }
                if (research.wood > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ğŸªµ ${research.wood}`;
                    costs.appendChild(cost);
                }
                if (research.stone > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ğŸª¨ ${research.stone}`;
                    costs.appendChild(cost);
                }
                if (research.gold > 0) {
                    const cost = document.createElement('div');
                    cost.className = 'tooltip-cost';
                    cost.textContent = `ğŸ’° ${research.gold}`;
                    costs.appendChild(cost);
                }
                
                tooltip.appendChild(costs);
                
                const time = document.createElement('div');
                time.className = 'tooltip-time';
                time.textContent = `â±ï¸ ${research.research_time}ì´ˆ`;
                tooltip.appendChild(time);
                
                if (research.required_researchs && research.required_researchs.trim() !== '') {
                    const req = document.createElement('div');
                    req.className = 'tooltip-requirement';
                    const parts = research.required_researchs.split(':');
                    req.textContent = `í•„ìš”: ì—°êµ¬ ${parts[0]} Lv.${parts[1]}`;
                    tooltip.appendChild(req);
                }
            }
            
            return tooltip;
        }
        
        function drawConnectionLine(container, fromIdx, requiredResearchs) {
            // SVGë¥¼ ì‚¬ìš©í•œ ì—°ê²°ì„ ì€ ë³µì¡í•˜ë¯€ë¡œ ê°„ë‹¨íˆ êµ¬í˜„
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë” ì •êµí•œ ë¡œì§ í•„ìš”
        }
        
        function checkRequirements(requiredResearchs) {
            if (!requiredResearchs || requiredResearchs.trim() === '') {
                return true;
            }
            
            const parts = requiredResearchs.split(':');
            const reqIdx = parseInt(parts[0]);
            const reqLv = parseInt(parts[1]);
            
            if (!userResearchData[reqIdx] || !userResearchData[reqIdx][reqLv]) {
                return false;
            }
            
            return userResearchData[reqIdx][reqLv].status === 2;
        }
        
        function openModal(researchIdx, researchList, currentLevel, nextLevel, hasInProgress) {
            const modal = document.getElementById('modalOverlay');
            const research = researchList.find(r => r.research_lv === nextLevel) || researchList[researchList.length - 1];
            const maxLevel = researchList[researchList.length - 1].research_lv;
            
            currentModalData = { researchIdx, nextLevel, hasInProgress };
            
            document.getElementById('modalTitle').textContent = research[CURRENT_LANGUAGE_FIELD];
            document.getElementById('modalCurrentLevel').textContent = `${currentLevel} / ${maxLevel}`;
            document.getElementById('modalNextLevel').textContent = currentLevel < maxLevel ? nextLevel : 'ìµœëŒ€ ë ˆë²¨';
            document.getElementById('modalTime').textContent = `${research.research_time}ì´ˆ`;
            
            const costsDiv = document.getElementById('modalCosts');
            costsDiv.innerHTML = '';
            
            if (research.food > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ğŸŒ¾ ì‹ëŸ‰: ${research.food}`;
                costsDiv.appendChild(cost);
            }
            if (research.wood > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ğŸªµ ëª©ì¬: ${research.wood}`;
                costsDiv.appendChild(cost);
            }
            if (research.stone > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ğŸª¨ ì„ì¬: ${research.stone}`;
                costsDiv.appendChild(cost);
            }
            if (research.gold > 0) {
                const cost = document.createElement('div');
                cost.className = 'modal-cost-item';
                cost.textContent = `ğŸ’° ê¸ˆ: ${research.gold}`;
                costsDiv.appendChild(cost);
            }
            
            const reqDiv = document.getElementById('modalRequirement');
            if (research.required_researchs && research.required_researchs.trim() !== '') {
                const parts = research.required_researchs.split(':');
                reqDiv.textContent = `âš ï¸ í•„ìš” ì¡°ê±´: ì—°êµ¬ ${parts[0]} Lv.${parts[1]} ì™„ë£Œ í•„ìš”`;
                reqDiv.style.display = 'block';
            } else {
                reqDiv.style.display = 'none';
            }
            
            const buttonsDiv = document.getElementById('modalButtons');
            buttonsDiv.innerHTML = '';
            
            const canStart = !hasInProgress && currentLevel < maxLevel && checkRequirements(research.required_researchs);
            const userData = userResearchData[researchIdx]?.[nextLevel];
            
            if (hasInProgress && userData && userData.status === 1) {
                const completeBtn = document.createElement('button');
                completeBtn.textContent = 'ì¦‰ì‹œì™„ë£Œ';
                completeBtn.className = 'btn-complete';
                completeBtn.onclick = () => {
                    closeModal();
                    callAPI(3003, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(completeBtn);
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'ì·¨ì†Œ';
                cancelBtn.className = 'btn-cancel';
                cancelBtn.onclick = () => {
                    closeModal();
                    callAPI(3004, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(cancelBtn);
            } else if (currentLevel === maxLevel) {
                const completedBtn = document.createElement('button');
                completedBtn.textContent = 'ì—°êµ¬ ì™„ë£Œ';
                completedBtn.className = 'btn-close';
                completedBtn.onclick = closeModal;
                buttonsDiv.appendChild(completedBtn);
            } else {
                const startBtn = document.createElement('button');
                startBtn.textContent = 'ì—°êµ¬ ì‹œì‘';
                startBtn.className = 'btn-start';
                startBtn.disabled = !canStart;
                startBtn.onclick = () => {
                    closeModal();
                    callAPI(3002, parseInt(researchIdx), nextLevel);
                };
                buttonsDiv.appendChild(startBtn);
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'ë‹«ê¸°';
                closeBtn.className = 'btn-close';
                closeBtn.onclick = closeModal;
                buttonsDiv.appendChild(closeBtn);
            }
            
            modal.classList.add('active');
        }
        
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            currentModalData = null;
        }
        
        async function callAPI(apiCode, researchIdx, level) {
            if (!userId) {
                showResult('í”Œë ˆì´ì–´ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            const researchList = researchConfigData[researchIdx];
            const research = researchList ? researchList.find(r => r.research_lv === level) : null;
            const researchName = research ? research[CURRENT_LANGUAGE_FIELD] : `ì—°êµ¬ ${researchIdx}`;
            
            try {
                showResult(`${researchName} Lv.${level} ìš”ì²­ ì¤‘...`);
                
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: apiCode,
                        data: {
                            research_idx: researchIdx,
                            research_lv: level
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`ğŸ”§ ${researchName} API í˜¸ì¶œ ê²°ê³¼:`, result);
                
                if (result.success) {
                    if (result.data) {
                        if (!userResearchData[researchIdx]) {
                            userResearchData[researchIdx] = {};
                        }
                        userResearchData[researchIdx][level] = result.data;
                    }
                    
                    await loadResearch();
                    
                    if ((apiCode === 3002) && result.data && result.data.status !== 0) {
                        startDisplayTimer();
                    }
                    
                    showResult(`${researchName} Lv.${level} ì„±ê³µ: ${result.message || 'ì™„ë£Œ'}`);
                } else {
                    showResult(`${researchName} Lv.${level} ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error(`âŒ ${researchName} API ì—ëŸ¬:`, error);
                showResult(`${researchName} Lv.${level} ì—ëŸ¬: ${error.message}`);
            }
        }
        
        function showResult(message) {
            const resultBox = document.getElementById('result');
            resultBox.style.display = 'block';
            resultBox.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.log(`ğŸ“¢ ${message}`);
        }
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ‘€ í˜ì´ì§€ í™œì„±í™” - í™”ë©´ ì—…ë°ì´íŠ¸ ì¬ì‹œì‘');
                startDisplayTimer();
            } else {
                console.log('ğŸ˜´ í˜ì´ì§€ ë¹„í™œì„±í™”');
            }
        });
        
        window.onbeforeunload = function() {
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            console.log('ğŸ”„ í˜ì´ì§€ ì¢…ë£Œ - íƒ€ì´ë¨¸ ì •ë¦¬');
        };
    </script>
        
       