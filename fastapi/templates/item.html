<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이템 관리</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; padding: 10px; background-color: white; margin: 0; }
        .game-section h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd; font-size: 16px; }
        .container { max-width: 100%; margin: 0; }
        .table-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start; }
        .item-table { width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 12px; }
        .item-table th, .item-table td { padding: 4px 4px; text-align: center; border: 1px solid #ddd; line-height: 1.3; height: 12px; }
        .item-table th { background-color: #f5f5f5; font-weight: bold; }
        .btn-use { padding: 3px 8px; background: #fff; color: #333; border: 1px solid #ddd; cursor: pointer; font-size: 11px; }
        .btn-use:hover { background: #555; }
        .btn-use:disabled { background: #ccc; cursor: not-allowed; }
        .result-box { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .empty-msg { text-align: center; padding: 20px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-section">
            <h3>Item</h3>
            <div id="item-list" class="table-wrapper">
                <div class="empty-msg">데이터를 불러오는 중...</div>
            </div>
            <div id="result" class="result-box"></div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let itemConfigs = null;

        window.addEventListener('message', async function(event) {
            
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = parseInt(event.data.userId);
                if (currentUserId !== newUserId) {
                    currentUserId = newUserId;
                    await loadItems(); 
                }
            }
            
            if (event.data && event.data.type === 'response_config') {
                itemConfigs = event.data.payload;
                await loadItems();
                console.log("ItemConfigs:", itemConfigs)
            }
            
            if (event.data.type === 'refresh_items') {
                await loadItems();
            }
        });

        function getUserNo() {
            if (currentUserId) return currentUserId;
            if (window.parent && window.parent.currentUserId) {
                currentUserId = parseInt(window.parent.currentUserId);
                return currentUserId;
            }
            return null;
        }

        async function loadItems() {
            const uid = getUserNo();
            if (!uid) return;

            if (!itemConfigs) {
                window.parent.postMessage({ type: 'request_config', configType: 'item' }, '*');
            }

            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: uid,
                        api_code: 6001,
                        data: {}
                    })
                });
                const result = await response.json();
                console.log("ItemInfo Request: ", result)
                if (result.success && result.data) {
                    renderItems(result.data);
                } else {
                    document.getElementById('item-list').innerHTML = 
                        '<div class="empty-msg" style="grid-column: span 2;">보유 아이템이 없습니다.</div>';
                }
            } catch (error) {
                console.error('API Error:', error);
            }
        }

        function renderItems(data) {
            const container = document.getElementById('item-list');
            const itemKeys = Object.keys(data).filter(key => !isNaN(key));

            // 수량 > 0인 아이템만 필터
            const validItems = itemKeys.filter(key => (data[key].quantity || 0) > 0);

            if (validItems.length === 0) {
                container.innerHTML = '<div class="empty-msg" style="grid-column: span 2;">보유 중인 아이템이 없습니다.</div>';
                return;
            }

            // 왼쪽/오른쪽 분배
            const half = Math.ceil(validItems.length / 2);
            const leftItems = validItems.slice(0, half);
            const rightItems = validItems.slice(half);

            function buildTable(items) {
                if (items.length === 0) {
                    return `<table class="item-table">
                        <thead><tr><th>이름</th><th>보유량</th><th>액션</th></tr></thead>
                        <tbody><tr><td colspan="3" style="text-align:center; color:#999;">-</td></tr></tbody>
                    </table>`;
                }

                let rows = '';
                items.forEach(key => {
                    const item = data[key];
                    const quantity = item.quantity || 0;
                    const config = (itemConfigs && (itemConfigs[key] || itemConfigs[parseInt(key)])) 
                                ? (itemConfigs[key] || itemConfigs[parseInt(key)])
                                : { korean_name: `아이템 ${key}` };
                    
                    rows += `<tr>
                        <td><strong>${config.korean_name}</strong></td>
                        <td>${quantity.toLocaleString()}</td>
                        <td><button class="btn-use" onclick="useItem(${key})">사용</button></td>
                    </tr>`;
                });

                return `<table class="item-table">
                    <thead><tr><th>이름</th><th>보유량</th><th>액션</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>`;
            }

            container.innerHTML = buildTable(leftItems) + buildTable(rightItems);
        }

        async function useItem(itemIdx) {
            //if (!confirm('아이템을 사용하시겠습니까?')) return;
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: getUserNo(),
                        api_code: 6003,
                        data: { item_idx: itemIdx, quantity: 1 }
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showResult('사용 성공!', 'success');
                    await loadItems();
                    window.parent.postMessage({ type: 'refresh_resource' }, '*');
                } else {
                    showResult('실패: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('오류 발생', 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result-box ${type}`;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 3000);
        }

        window.onload = function() {
            window.parent.postMessage({ type: 'request_config', configType: 'item' }, '*');
            const uid = getUserNo();
            if (uid) loadItems();
        };
    </script>
</body>
</html>