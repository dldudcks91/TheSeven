<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´í…œ ê´€ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            padding: 10px;
            background-color: white;
            margin: 0;
        }
        
        .game-section h3 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
        }
        
        strong {
            margin-right: 10px;
        }
        
        .item-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .item-table th,
        .item-table td {
            padding: 6px 8px;
            text-align: left;
            border: 1px solid #ddd;
            line-height: 1.3;
        }
        
        .item-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .item-table th:nth-child(1) { width: 8%; }   /* ì•„ì´í…œ ID */
        .item-table th:nth-child(2) { width: 25%; }  /* ì•„ì´í…œëª… */
        .item-table th:nth-child(3) { width: 12%; }  /* ì¹´í…Œê³ ë¦¬ */
        .item-table th:nth-child(4) { width: 15%; }  /* ìˆ˜ëŸ‰ */
        .item-table th:nth-child(5) { width: 25%; }  /* ì„¤ëª… */
        .item-table th:nth-child(6) { width: 15%; }  /* ì•¡ì…˜ */
        
        .item-icon {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .item-name {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .category-resource { background: #e8f5e9; color: #2e7d32; }
        .category-speedup { background: #e3f2fd; color: #1976d2; }
        .category-boost { background: #fff3e0; color: #e65100; }
        .category-chest { background: #f3e5f5; color: #7b1fa2; }
        .category-special { background: #fce4ec; color: #c2185b; }
        
        .quantity-display {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            text-align: center;
        }
        
        .quantity-zero {
            color: #999;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-buttons button {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 10px;
            border-radius: 3px;
        }
        
        .action-buttons button:hover {
            background: #f0f0f0;
        }
        
        .action-buttons button:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .result-box {
            margin-top: 10px;
            padding: 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .result-box.success {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .result-box.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .filter-section {
            margin-bottom: 10px;
            padding: 8px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .filter-section select {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 10px;
        }
        
        .stats-section {
            margin-bottom: 10px;
            padding: 8px;
            background: #f0f8ff;
            border: 1px solid #90caf9;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .stats-section strong {
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-section">
            <h3>ğŸ’ ì•„ì´í…œ ë³´ê´€í•¨</h3>
            
            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="stats-section">
                <strong>ì´ ì•„ì´í…œ ì¢…ë¥˜:</strong> <span id="total-items">0</span>
                <strong>ì´ ìˆ˜ëŸ‰:</strong> <span id="total-quantity">0</span>
            </div>
            
            <!-- í•„í„° ì„¹ì…˜ -->
            <div class="filter-section">
                <label for="category-filter">ì¹´í…Œê³ ë¦¬:</label>
                <select id="category-filter" onchange="applyFilter()">
                    <option value="all">ì „ì²´</option>
                    <option value="resource">ìì›</option>
                    <option value="speedup">ê°€ì†</option>
                    <option value="boost">ë¶€ìŠ¤íŠ¸</option>
                    <option value="chest">ìƒì</option>
                    <option value="special">íŠ¹ìˆ˜</option>
                </select>
                
                <label>
                    <input type="checkbox" id="hide-zero" onchange="applyFilter()">
                    0ê°œ ì•„ì´í…œ ìˆ¨ê¸°ê¸°
                </label>
            </div>
            
            <!-- ì•„ì´í…œ í…Œì´ë¸” -->
            <table class="item-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì•„ì´í…œëª…</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ì„¤ëª…</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="itemTableBody">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </tbody>
            </table>
            
            <div id="result" class="result-box" style="display: none;"></div>
        </div>
    </div>

    <script>
        const CURRENT_LANGUAGE_FIELD = 'korean_name';
        
        // ì•„ì´í…œ ì•„ì´ì½˜ ë§¤í•‘
        const itemIconMap = {
            // ìì›ë¥˜
            11001: 'ğŸŒ¾', // ì‹ëŸ‰
            11002: 'ğŸªµ', // ëª©ì¬
            11003: 'ğŸ—¿', // ì„ì¬
            11004: 'ğŸ’°', // ê³¨ë“œ
            11005: 'ğŸ’', // ë£¨ë¹„
            
            // ê°€ì†ë¥˜
            12001: 'âš¡', // ì¼ë°˜ ê°€ì†
            12002: 'â±ï¸', // ê±´ì„¤ ê°€ì†
            12003: 'ğŸ”¬', // ì—°êµ¬ ê°€ì†
            12004: 'âš”ï¸', // í›ˆë ¨ ê°€ì†
            
            // ë¶€ìŠ¤íŠ¸ë¥˜
            13001: 'ğŸ“ˆ', // ìì› ìƒì‚° ë¶€ìŠ¤íŠ¸
            13002: 'ğŸ›¡ï¸', // ë°©ì–´ ë¶€ìŠ¤íŠ¸
            13003: 'âš”ï¸', // ê³µê²© ë¶€ìŠ¤íŠ¸
            
            // ìƒìë¥˜
            14001: 'ğŸ“¦', // ì¼ë°˜ ìƒì
            14002: 'ğŸ', // ê³ ê¸‰ ìƒì
            14003: 'ğŸ’¼', // ì „ì„¤ ìƒì
            
            // íŠ¹ìˆ˜ ì•„ì´í…œ
            15001: 'ğŸ«', // í…”ë ˆí¬íŠ¸
            15002: 'ğŸ”®', // ëœë¤ í…”ë ˆí¬íŠ¸
            15003: 'ğŸ›¡ï¸', // í‰í™” ë°©íŒ¨
        };
        
        // ì•„ì´í…œ ì´ë¦„ ë§¤í•‘
        const itemNameMap = {
            11001: { english_name: 'Food', korean_name: 'ì‹ëŸ‰' },
            11002: { english_name: 'Wood', korean_name: 'ëª©ì¬' },
            11003: { english_name: 'Stone', korean_name: 'ì„ì¬' },
            11004: { english_name: 'Gold', korean_name: 'ê³¨ë“œ' },
            11005: { english_name: 'Ruby', korean_name: 'ë£¨ë¹„' },
            
            12001: { english_name: 'General Speedup', korean_name: 'ì¼ë°˜ ê°€ì†' },
            12002: { english_name: 'Building Speedup', korean_name: 'ê±´ì„¤ ê°€ì†' },
            12003: { english_name: 'Research Speedup', korean_name: 'ì—°êµ¬ ê°€ì†' },
            12004: { english_name: 'Training Speedup', korean_name: 'í›ˆë ¨ ê°€ì†' },
            
            13001: { english_name: 'Resource Boost', korean_name: 'ìì› ìƒì‚° ë¶€ìŠ¤íŠ¸' },
            13002: { english_name: 'Defense Boost', korean_name: 'ë°©ì–´ ë¶€ìŠ¤íŠ¸' },
            13003: { english_name: 'Attack Boost', korean_name: 'ê³µê²© ë¶€ìŠ¤íŠ¸' },
            
            14001: { english_name: 'Common Chest', korean_name: 'ì¼ë°˜ ìƒì' },
            14002: { english_name: 'Advanced Chest', korean_name: 'ê³ ê¸‰ ìƒì' },
            14003: { english_name: 'Legendary Chest', korean_name: 'ì „ì„¤ ìƒì' },
            
            15001: { english_name: 'Teleport', korean_name: 'í…”ë ˆí¬íŠ¸' },
            15002: { english_name: 'Random Teleport', korean_name: 'ëœë¤ í…”ë ˆí¬íŠ¸' },
            15003: { english_name: 'Peace Shield', korean_name: 'í‰í™” ë°©íŒ¨' },
        };
        
        let allItemsList = [];
        let userItemData = {};
        let userId = null;
        let itemConfigData = {};
        
        window.onload = function() {
            window.parent.postMessage({
                type: 'request_config',
                configType: 'item'
            }, '*');
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = event.data.userId;
                
                if (userId !== newUserId) {
                    userId = newUserId;
                    
                    if (Object.keys(itemConfigData).length > 0) {
                        loadItems();
                    }
                }
            }
            
            if (event.data && event.data.type === 'response_config') {
                const itemConfig = event.data.payload;
                itemConfigData = itemConfig;
                console.log('Item config received:', itemConfigData);
                
                // config ë°ì´í„° í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„ì´í…œ ëª©ë¡ ë™ì  ìƒì„±
                allItemsList = Object.keys(itemConfigData).map(idxStr => {
                    const idx = parseInt(idxStr);
                    const names = itemNameMap[idx] || { 
                        english_name: `Item_${idx}`, 
                        korean_name: `ì•„ì´í…œ ${idx}` 
                    };
                    const config = itemConfigData[idx];
                    
                    return {
                        idx: idx,
                        english_name: names.english_name,
                        korean_name: names.korean_name,
                        display_name: names[CURRENT_LANGUAGE_FIELD] || names.korean_name,
                        category: config.category || 'special',
                        description: config.description || '',
                        icon: itemIconMap[idx] || 'ğŸ“¦'
                    };
                }).sort((a, b) => a.idx - b.idx);
                
                if (userId) {
                    loadItems();
                }
            }
        });
        
        async function loadItems() {
            if (!userId) {
                console.log('Item: í”Œë ˆì´ì–´ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 6001, // ITEM_INFO
                        data: {}
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    userItemData = result.data;
                    generateItemTable();
                    updateStats();
                    console.log('Item ì •ë³´ ë¡œë“œ ì„±ê³µ:', userItemData);
                } else {
                    showResult('ì•„ì´í…œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Item ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                showResult('ì•„ì´í…œ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
        
        function getCategoryBadge(category) {
            const categoryNames = {
                'resource': 'ìì›',
                'speedup': 'ê°€ì†',
                'boost': 'ë¶€ìŠ¤íŠ¸',
                'chest': 'ìƒì',
                'special': 'íŠ¹ìˆ˜'
            };
            
            return `<span class="category-badge category-${category}">${categoryNames[category] || category}</span>`;
        }
        
        function generateItemTable() {
            const tbody = document.getElementById('itemTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            allItemsList.forEach(item => {
                const quantity = userItemData[item.idx]?.quantity || 0;
                const config = itemConfigData[item.idx] || {};
                
                const row = document.createElement('tr');
                row.dataset.category = item.category;
                row.dataset.quantity = quantity;
                
                const useButton = quantity > 0 ? 
                    `<button onclick="useItem(${item.idx})">ì‚¬ìš©</button>` : 
                    `<button disabled>ì‚¬ìš©</button>`;
                
                row.innerHTML = `
                    <td style="text-align: center; color: #666;">${item.idx}</td>
                    <td>
                        <div class="item-name">
                            <span class="item-icon">${item.icon}</span>
                            <span>${item.display_name}</span>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        ${getCategoryBadge(item.category)}
                    </td>
                    <td>
                        <div class="quantity-display ${quantity === 0 ? 'quantity-zero' : ''}">
                            ${quantity.toLocaleString()}
                        </div>
                    </td>
                    <td style="font-size: 10px; color: #666;">
                        ${config.description || item.description || '-'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${useButton}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function applyFilter() {
            const categoryFilter = document.getElementById('category-filter').value;
            const hideZero = document.getElementById('hide-zero').checked;
            
            const rows = document.querySelectorAll('#itemTableBody tr');
            
            rows.forEach(row => {
                const category = row.dataset.category;
                const quantity = parseInt(row.dataset.quantity);
                
                let show = true;
                
                // ì¹´í…Œê³ ë¦¬ í•„í„°
                if (categoryFilter !== 'all' && category !== categoryFilter) {
                    show = false;
                }
                
                // 0ê°œ ìˆ¨ê¸°ê¸° í•„í„°
                if (hideZero && quantity === 0) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            updateStats();
        }
        
        function updateStats() {
            const visibleRows = document.querySelectorAll('#itemTableBody tr:not([style*="display: none"])');
            
            let totalQuantity = 0;
            visibleRows.forEach(row => {
                totalQuantity += parseInt(row.dataset.quantity) || 0;
            });
            
            document.getElementById('total-items').textContent = visibleRows.length;
            document.getElementById('total-quantity').textContent = totalQuantity.toLocaleString();
        }
        
        async function useItem(itemIdx) {
            if (!userId) {
                showResult('í”Œë ˆì´ì–´ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!confirm(`ì•„ì´í…œ ${itemIdx}ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 6003, // USE_ITEM
                        data: {
                            item_idx: itemIdx,
                            quantity: 1
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult(`ì•„ì´í…œ ì‚¬ìš© ì„±ê³µ: ${itemIdx}`, 'success');
                    await loadItems(); // ìƒˆë¡œê³ ì¹¨
                    
                    // ìì›ì´ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ resource.htmlì— ì•Œë¦¼
                    window.parent.postMessage({
                        type: 'refresh_resource'
                    }, '*');
                } else {
                    showResult('ì•„ì´í…œ ì‚¬ìš© ì‹¤íŒ¨: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('ì•„ì´í…œ ì‚¬ìš© ì‹¤íŒ¨:', error);
                showResult('ì•„ì´í…œ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result-box ${type}`;
            resultDiv.style.display = 'block';
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>