<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이템 관리</title>
    <style>
        /* 기존 디자인 유지 */
        body { font-family: Arial, sans-serif; font-size: 12px; padding: 10px; background-color: white; margin: 0; }
        .game-section h3 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #ddd; font-size: 16px; }
        .container { max-width: 100%; margin: 0; }
        strong { margin-right: 10px; }
        .item-table { width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 12px; }
        .item-table th, .item-table td { padding: 6px 8px; text-align: left; border: 1px solid #ddd; line-height: 1.3; }
        .item-table th { background-color: #f5f5f5; font-weight: bold; }
        .btn-use { padding: 4px 8px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 3px; }
        .btn-use:hover { background-color: #0056b3; }
        .result-box { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-section">
            <h3>내 인벤토리</h3>
            <table class="item-table">
                <thead>
                    <tr>
                        <th>아이템 ID</th>
                        <th>이름</th>
                        <th>설명</th>
                        <th>보유량</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="item-list">
                    <tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">데이터를 불러오는 중...</td></tr>
                </tbody>
            </table>
            <div id="result" class="result-box"></div>
        </div>
    </div>

    <script>
        let currentUserId = null;
        let itemConfigs = null;

        // 메시지 감지 및 실시간 유저 동기화
        window.addEventListener('message', async function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = parseInt(event.data.userId);
                if (currentUserId !== newUserId) {
                    currentUserId = newUserId;
                    await loadItems(); 
                }
            }
            
            if (event.data && event.data.type === 'response_config' && event.data.configType === 'item') {
                itemConfigs = event.data.payload;
                await loadItems();
            }
        });

        function getUserNo() {
            if (currentUserId) return currentUserId;
            if (window.parent && window.parent.currentUserId) {
                currentUserId = parseInt(window.parent.currentUserId);
                return currentUserId;
            }
            return null;
        }

        async function loadItems() {
            const uid = getUserNo();
            if (!uid) return;

            // Config가 없으면 부모에게 요청
            if (!itemConfigs) {
                window.parent.postMessage({ type: 'request_config', configType: 'item' }, '*');
                // Config가 올 때까지 기다리지 않고 일단 API 호출은 진행
            }

            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: uid,
                        api_code: 6001
                    })
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    renderItems(result.data);
                } else {
                    document.getElementById('item-list').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">보유 아이템이 없습니다.</td></tr>';
                }
            } catch (error) {
                console.error('API Error:', error);
            }
        }

        function renderItems(data) {
            const tbody = document.getElementById('item-list');
            
            // [핵심] JSON의 키값들 중 숫자로 된 것(아이템 ID)만 필터링
            const itemKeys = Object.keys(data).filter(key => !isNaN(key));

            if (itemKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">보유 중인 아이템이 없습니다.</td></tr>';
                return;
            }

            let html = '';
            itemKeys.forEach(key => {
                const item = data[key];
                const quantity = item.quantity || 0;
                
                if (quantity > 0) {
                    // Config 정보가 있으면 사용, 없으면 기본값
                    const config = (itemConfigs && itemConfigs[key]) 
                                   ? itemConfigs[key] 
                                   : { korean_name: `아이템 ${key}`, description: '-' };
                    
                    html += `
                        <tr>
                            <td>${key}</td>
                            <td><strong>${config.korean_name}</strong></td>
                            <td>${config.description || '-'}</td>
                            <td>${quantity.toLocaleString()}</td>
                            <td>
                                <button class="btn-use" onclick="useItem(${key})">사용</button>
                            </td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">보유 중인 아이템이 없습니다.</td></tr>';
        }

        async function useItem(itemIdx) {
            if (!confirm('아이템을 사용하시겠습니까?')) return;
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: getUserNo(),
                        api_code: 6003,
                        data: { item_idx: itemIdx, quantity: 1 }
                    })
                });
                const result = await response.json();
                if (result.success) {
                    showResult(`사용 성공!`, 'success');
                    await loadItems();
                    window.parent.postMessage({ type: 'refresh_resource' }, '*');
                } else {
                    showResult('실패: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('오류 발생', 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result-box ${type}`;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 3000);
        }

        window.onload = function() {
            window.parent.postMessage({ type: 'request_config', configType: 'item' }, '*');
            const uid = getUserNo();
            if (uid) loadItems();
        };
    </script>
</body>
</html>