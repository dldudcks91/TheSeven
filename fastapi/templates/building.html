<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í±¥Î¨º Í¥ÄÎ¶¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            padding: 10px;
            background-color: white;
            margin: 0;
        }
        .game-section h3 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
        .container {
            max-width: 100%;
            margin: 0;
        }
        strong {
        margin-right: 10px;
        }
        .building-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .building-table th,
        .building-table td {
            padding: 4px 6px;
            text-align: left;
            border: 1px solid #ddd;
            line-height: 1.2;
        }
        
        .building-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            font-size: 12px;
        }
        
        .action-buttons button {
            margin-right: 3px;
            padding: 2px 5px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-size: 9px;
            border-radius: 2px;
        }
        
        .timer {
            font-family: monospace;
            font-size: 12px;
        }
        
        .timer-display {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f0f8ff;
            border-radius: 4px;
            font-size: 12px;
            
        }
        
        .timer-item {
            display: inline-block;
            margin-right: 15px;
            margin-bottom: 5px;
            padding: 3px 6px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .timer-item.completed {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .timer-item.running {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }
        
        .result-box {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            display: none;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="game-section"><h3>Construct</h3></div>
    
    <div class="container">
        <div id="timerDisplay" class="timer-display" style="display: none; ">
            <strong>ÏßÑÌñâ Ï§ëÏù∏ ÏûëÏóÖ: </strong>
            <div id="timerItems"></div>
        </div>
        
        <table class="building-table">
            <thead>
                <tr>
                    <th>Í±¥Î¨ºÎ™Ö</th>
                    <th>Î†àÎ≤®</th>
                    <th>ÏÉÅÌÉú</th>
                    <th>ÎπÑÏö©</th>
                    <th>ÏãúÍ∞Ñ</th>
                    <th>Í¥ÄÎ¶¨</th>
                </tr>
            </thead>
            <tbody id="buildingTableBody">
                </tbody>
        </table>
        
        <div id="result" class="result-box"></div>
    </div>

    <script>
        // ‚≠ê Îã§Íµ≠Ïñ¥ ÏÑ§Ï†ïÏùÑ ÏúÑÌïú ÏÉÅÏàò: 'korean_name' ÎòêÎäî 'english_name' Îì±ÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•
        const CURRENT_LANGUAGE_FIELD = 'korean_name'; // üëà [Î≥ÄÍ≤Ω/Ï∂îÍ∞Ä] Ïñ∏Ïñ¥ ÏÑ§Ï†ï ÏÉÅÏàò

        // ÌïòÎìúÏΩîÎî©Îêú Í±¥Î¨º Î™©Î°ù ÎåÄÏã† Ïù¥Î¶Ñ Îß§ÌïëÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.
        const buildingNameMap = {
            201: { english_name: 'town_hall', korean_name: 'ÏãúÏ≤≠' },
            301: { english_name: 'academy', korean_name: 'ÏïÑÏπ¥Îç∞ÎØ∏' },
            401: { english_name: 'barracks', korean_name: 'Î≥ëÏòÅ' },
            501: { english_name: 'farm', korean_name: 'ÎÜçÏû•' },
            502: { english_name: 'LumberMill', korean_name: 'Ï†úÏû¨ÏÜå' }, // korean_name ÏàòÏ†ï
            503: { english_name: 'Quarry', korean_name: 'Ï±ÑÏÑùÏû•' }, // korean_name ÏàòÏ†ï
        };
        
        let allBuildingsList = []; // config Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú ÏÉùÏÑ±Îê† ÏµúÏ¢Ö Í±¥Î¨º Î™©Î°ù
        let userBuildingData = {};
        let displayTimer = null;
        let userId = null;
        let buildingCostData = {};
        
        let completedBuildingChecks = new Set();
        
        window.onload = function() {
            window.parent.postMessage({
                type: 'request_config',
                configType: 'building'
            }, '*');
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set_player_id') {
                const newUserId = event.data.userId;
                
                if (userId !== newUserId) {
                    userId = newUserId;
                    
                    // configÍ∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Î°úÎìú
                    if (Object.keys(buildingCostData).length > 0) {
                        loadBuildings();
                    }
                }
            }
            if (event.data && event.data.type === 'response_config') {
                const buildingConfig = event.data.payload;
                buildingCostData = buildingConfig;
                console.log('Building data received:', buildingCostData);
                
                // config Îç∞Ïù¥ÌÑ∞ ÌÇ§Î•º Í∏∞Î∞òÏúºÎ°ú Í±¥Î¨º Î™©Î°ù ÎèôÏ†Å ÏÉùÏÑ±
                allBuildingsList = Object.keys(buildingCostData).map(idxStr => {
                    const idx = parseInt(idxStr);
                    const names = buildingNameMap[idx] || { english_name: `unknown_${idx}`, korean_name: `[${idx}] Ïù¥Î¶Ñ ÏóÜÏùå` };
                    return {
                        idx: idx,
                        english_name: names.english_name,
                        korean_name: names.korean_name,
                        // ‚≠ê [Î≥ÄÍ≤Ω] ÏÉÅÏàò Ï†ÅÏö©: ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïñ∏Ïñ¥ ÌïÑÎìúÎ•º display_nameÏúºÎ°ú Ï†ÄÏû•
                        display_name: names[CURRENT_LANGUAGE_FIELD] || names.korean_name
                    };
                }).sort((a, b) => a.idx - b.idx);
                
                // configÍ∞Ä Î°úÎìúÎêú ÌõÑ userIdÍ∞Ä ÏûàÏúºÎ©¥ Í±¥Î¨º Ï†ïÎ≥¥ Î°úÎìú ÏãúÏûë
                if (userId) {
                    loadBuildings();
                }
            }
        });

        function parseServerUTCTime(serverTimeString) {
            let utcString = serverTimeString;
            
            if (utcString.includes(' ') && !utcString.includes('T')) {
                utcString = utcString.replace(' ', 'T');
            }
            
            if (!utcString.endsWith('Z') && utcString.includes('T')) {
                utcString += 'Z';
            }
            
            return new Date(utcString);
        }

        function calculateUTCTimeDiff(serverUTCTime) {
            const endTime = parseServerUTCTime(serverUTCTime);
            const now = new Date();
            
            const diffMs = endTime - now;
            const diffSeconds = Math.max(0, Math.ceil(diffMs / 1000));
            
            return {
                totalMs: diffMs,
                totalSeconds: diffSeconds,
                minutes: Math.floor(diffSeconds / 60),
                seconds: diffSeconds % 60,
                isCompleted: diffMs <= 0,
                
                format: () => {
                    if (diffMs <= 0) return "ÏôÑÎ£å";
                    const mins = Math.floor(diffSeconds / 60);
                    const secs = diffSeconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                }
            };
        }
        
        // ÎπÑÏö© Ìè¨Îß∑ÌåÖ Ìó¨Ìçº Ìï®Ïàò Ï∂îÍ∞Ä (Ïú†ÎãõÍ≥º ÎèôÏùºÌïú Ïù¥Î™®ÏßÄ ÏÇ¨Ïö©)
        function formatCosts(costs) {
            if (!costs) return 'N/A';
            
            const parts = [];
            if (costs.food > 0) parts.push(`üåæ${costs.food}`);
            if (costs.wood > 0) parts.push(`ü™µ${costs.wood}`);
            if (costs.stone > 0) parts.push(`üóø${costs.stone}`);
            if (costs.gold > 0) parts.push(`üí∞${costs.gold}`);
            
            return parts.join(' / ');
        }


        function generateBuildingTable() {
            const tbody = document.getElementById('buildingTableBody');
            if (!tbody) {
                console.error("buildingTableBody ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }
            tbody.innerHTML = '';
            
            // allBuildingsListÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÎèôÏ†ÅÏúºÎ°ú ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            allBuildingsList.forEach(building => {
                const data = userBuildingData[building.idx] || { building_lv: 0, status: 0 };
                
                // Îã§Ïùå Î†àÎ≤®Ïùò ÎπÑÏö©Í≥º ÏãúÍ∞Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const nextLevelConfig = buildingCostData?.[building.idx]?.[data.building_lv + 1];
                
                let costDisplay = 'ÏµúÍ≥† Î†àÎ≤®';
                let timeDisplay = '';
                let actionButton = 'ÏµúÍ≥† Î†àÎ≤®';
                let hasNextLevel = !!nextLevelConfig;

                if (hasNextLevel) {
                    costDisplay = formatCosts(nextLevelConfig.cost);
                    timeDisplay = `${nextLevelConfig.time}Ï¥à`;
                    
                    actionButton = data.building_lv === 0 ? 
                        `<button onclick="callAPI(2002, ${building.idx})">Í±¥ÏÑ§</button>` : 
                        `<button onclick="callAPI(2003, ${building.idx})">ÏóÖÍ∑∏Î†àÏù¥Îìú</button>`;
                }

                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-size: 9px;">${building.display_name || building.korean_name}</td>
                    <td>Lv.${data.building_lv}</td>
                    <td>${getStatusText(data.status)}</td>
                    <td>${costDisplay}</td>
                    <td>${timeDisplay}</td>
                    <td>
                        <div class="action-buttons">
                            ${actionButton}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            startDisplayTimer();
        }
        
        function getStatusText(status) {
            switch(status) {
                case 0: return 'Ï†ïÏÉÅ';
                case 1: return 'Í±¥ÏÑ§Ï§ë';
                case 2: return 'ÏóÖÍ∑∏Î†àÏù¥ÎìúÏ§ë';
                default: return 'Ïïå Ïàò ÏóÜÏùå';
            }
        }
        
        function startDisplayTimer() {
            if (displayTimer) clearInterval(displayTimer);
            
            displayTimer = setInterval(() => {
                updateDisplayOnly();
            }, 1000);
        }
        
        async function completeBuilding(buildingIdx) {
            const building = allBuildingsList.find(b => b.idx === buildingIdx);
            // ‚≠ê [Î≥ÄÍ≤Ω] display_name ÏÇ¨Ïö©
            const buildingName = building ? (building.display_name || building.korean_name) : buildingIdx; 
            
            const checkKey = `${buildingIdx}_${Date.now()}`;
            if (completedBuildingChecks.has(buildingIdx)) {
                console.log(`‚è≠Ô∏è ${buildingName} Ïù¥ÎØ∏ ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë...`);
                return;
            }
            
            completedBuildingChecks.add(buildingIdx);
            
            try {
                console.log(`‚úÖ ${buildingName} Í±¥ÏÑ§/ÏóÖÍ∑∏Î†àÏù¥Îìú ÏôÑÎ£å! API 2004 Ìò∏Ï∂ú ÏãúÏûë`);
                showResult(`${buildingName} ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë...`);
                
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 2004,
                        data: {
                            building_idx: buildingIdx
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`üéâ ${buildingName} ÏôÑÎ£å API Í≤∞Í≥º:`, result);
                
                if (result.success) {
                    if (result.data) {
                        userBuildingData[buildingIdx] = result.data;
                    }
                    
                    await loadBuildings();
                    showResult(`${buildingName} ÏôÑÎ£å! Î†àÎ≤®ÏóÖ ÏÑ±Í≥µ`);
                    
                    setTimeout(() => {
                        completedBuildingChecks.delete(buildingIdx);
                    }, 2000);
                } else {
                    showResult(`${buildingName} ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                    completedBuildingChecks.delete(buildingIdx);
                }
            } catch (error) {
                console.error(`‚ùå ${buildingName} ÏôÑÎ£å API ÏóêÎü¨:`, error);
                showResult(`${buildingName} ÏôÑÎ£å Ï≤òÎ¶¨ ÏóêÎü¨: ${error.message}`);
                completedBuildingChecks.delete(buildingIdx);
            }
        }
        
        function updateDisplayOnly() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timerItems = document.getElementById('timerItems');
            
            if (!timerDisplay || !timerItems) return;
            
            let hasActiveBuildings = false;
            timerItems.innerHTML = '';
            
            allBuildingsList.forEach(building => {
                const data = userBuildingData[building.idx];
                
                // ‚≠ê [Î≥ÄÍ≤Ω] display_name ÏÇ¨Ïö©
                console.log(`${building.display_name || building.korean_name} ÌÉÄÏù¥Î®∏ Ï≤¥ÌÅ¨:`, {
                    data: data,
                    status: data?.status,
                    end_time: data?.end_time,
                    hasData: !!data,
                    isActive: data && data.status !== 0 && data.end_time
                });
                
                if (!data || data.status === 0 || !data.end_time) {
                    return;
                }
                
                hasActiveBuildings = true;
                
                const timeDiff = calculateUTCTimeDiff(data.end_time);
                
                const timerItem = document.createElement('span');
                timerItem.className = 'timer-item';
                
                // ‚≠ê [Î≥ÄÍ≤Ω] display_name ÏÇ¨Ïö©
                if (!timeDiff.isCompleted) {
                    timerItem.textContent = `${building.display_name || building.korean_name}: ${timeDiff.format()}`;
                    timerItem.classList.add('running');
                } else {
                    timerItem.textContent = `${building.display_name || building.korean_name}: ÏôÑÎ£åÎê®`;
                    timerItem.classList.add('completed');
                    
                    completeBuilding(building.idx);
                }
                
                timerItems.appendChild(timerItem);
            });
            
            console.log(`ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏: ÌôúÏÑ± Í±¥Î¨º ${hasActiveBuildings ? 'ÏûàÏùå' : 'ÏóÜÏùå'}`);
            
            timerDisplay.style.display = hasActiveBuildings ? 'flex' : 'none';
            
            if (!hasActiveBuildings && displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
                console.log('üì∫ ÏßÑÌñâÏ§ëÏù∏ Í±¥Î¨º ÏóÜÏùå - ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ ÌÉÄÏù¥Î®∏ Ï§ëÎã®');
            }
        }
        
        async function loadBuildings() {
            if (!userId) {
                showResult('ÌîåÎ†àÏù¥Ïñ¥ IDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Î∂ÄÎ™® ÌéòÏù¥ÏßÄÏóêÏÑú IDÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (allBuildingsList.length === 0) {
                showResult('Í±¥Î¨º ÏÑ§Ï†ï Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            const previousData = { ...userBuildingData };
            userBuildingData = {};
            completedBuildingChecks.clear();
            
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            showResult('Í±¥Î¨º Ï†ïÎ≥¥ Î°úÎî© Ï§ë...');
            
            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: 2001,
                        data: {}
                    })
                });
                
                const result = await response.json();
                console.log('üèóÔ∏è Í±¥Î¨º Îç∞Ïù¥ÌÑ∞ Î°úÎìú:', result.data);
                
                if (result.success && result.data) {
                    for (const building of allBuildingsList) {
                        if (result.data[building.idx]) {
                            userBuildingData[building.idx] = result.data[building.idx];
                        } else {
                            userBuildingData[building.idx] = { building_lv: 0, status: 0 };
                        }
                    }
                } else {
                    for (const building of allBuildingsList) {
                        userBuildingData[building.idx] = previousData[building.idx] || { building_lv: 0, status: 0 };
                    }
                }
            } catch (error) {
                console.log(`Ï†ïÎ≥¥ Î°úÎìú ÏóêÎü¨:`, error);
                for (const building of allBuildingsList) {
                    userBuildingData[building.idx] = previousData[building.idx] || { building_lv: 0, status: 0 };
                }
            }
            
            generateBuildingTable();
            showResult('Í±¥Î¨º Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å');
        }
        
        async function callAPI(apiCode, buildingIdx) {
            if (!userId) {
                showResult('ÌîåÎ†àÏù¥Ïñ¥ IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            const building = allBuildingsList.find(b => b.idx === buildingIdx);
            // ‚≠ê [Î≥ÄÍ≤Ω] display_name ÏÇ¨Ïö©
            const buildingName = building ? (building.display_name || building.korean_name) : buildingIdx;
            
            try {
                showResult(`${buildingName} ÏöîÏ≤≠ Ï§ë...`);
                
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_no: parseInt(userId),
                        api_code: apiCode,
                        data: {
                            building_idx: buildingIdx
                        }
                    })
                });
                
                const result = await response.json();
                console.log(`üîß ${buildingName} API Ìò∏Ï∂ú Í≤∞Í≥º:`, result);
                
                if (result.success) {
                    if (result.data) {
                        userBuildingData[buildingIdx] = result.data;
                        console.log(`${buildingName} ÏóÖÎç∞Ïù¥Ìä∏Îêú Îç∞Ïù¥ÌÑ∞:`, result.data);
                    }
                    
                    await loadBuildings();
                    
                    if ((apiCode === 2002 || apiCode === 2003) && result.data && result.data.status !== 0) {
                        startDisplayTimer();
                    }
                    
                    showResult(`${buildingName} ÏÑ±Í≥µ: ${result.message || 'ÏôÑÎ£å'}`);
                } else {
                    showResult(`${buildingName} Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                }
            } catch (error) {
                console.error(`‚ùå ${buildingName} API ÏóêÎü¨:`, error);
                showResult(`${buildingName} ÏóêÎü¨: ${error.message}`);
            }
        }
        
        function showResult(message) {
            const resultBox = document.getElementById('result');
            resultBox.style.display = 'block';
            resultBox.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.log(`üì¢ ${message}`);
        }
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÄ ÌéòÏù¥ÏßÄ ÌôúÏÑ±Ìôî - ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïû¨ÏãúÏûë');
                startDisplayTimer();
            } else {
                console.log('üò¥ ÌéòÏù¥ÏßÄ ÎπÑÌôúÏÑ±Ìôî');
            }
        });
        
        window.onbeforeunload = function() {
            if (displayTimer) {
                clearInterval(displayTimer);
                displayTimer = null;
            }
            console.log('üîÑ ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å - ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨');
        };
    </script>
</body>
</html>